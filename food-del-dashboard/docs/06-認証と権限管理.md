# 06-èªè¨¼ã¨æ¨©é™ç®¡ç†

> Food-Del-Dashboard ã®JWTèªè¨¼ã¨ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰

## ğŸ“‹ ç›®æ¬¡

1. [èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [JWTèªè¨¼ãƒ•ãƒ­ãƒ¼](#jwtèªè¨¼ãƒ•ãƒ­ãƒ¼)
3. [ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†](#ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†)
4. [ZustandçŠ¶æ…‹ç®¡ç†](#zustandçŠ¶æ…‹ç®¡ç†)
5. [ProtectedRouteå®Ÿè£…](#protectedrouteå®Ÿè£…)
6. [æ¨©é™åˆ¶å¾¡ï¼ˆRBACï¼‰](#æ¨©é™åˆ¶å¾¡rbac)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)

---

## 1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 èªè¨¼æ–¹å¼

```
æ¡ç”¨æ–¹å¼: JWT (JSON Web Token)
ãƒˆãƒ¼ã‚¯ãƒ³ç¨®é¡:
  - Access Token  (æœ‰åŠ¹æœŸé™: 15åˆ†)
  - Refresh Token (æœ‰åŠ¹æœŸé™: 7æ—¥)

ä¿å­˜å ´æ‰€: localStorage (authStoreçµŒç”±)

è‡ªå‹•æ›´æ–°: httpClientã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã§401ã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
```

### 1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

ï¼ˆçœç•¥ï¼‰

### 1.3 è©³ç´°ãªèªè¨¼ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ]
     â†“
[ 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ (LoginPage) ]
   - ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
   - ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¯ãƒªãƒƒã‚¯
     â†“
[ 2. useAuth().login() ã‚’å‘¼ã³å‡ºã™ ]
     â†“
[ 3. React Query: useLogin ãŒ Mutation ã‚’ãƒˆãƒªã‚¬ãƒ¼ ]
     â†“
[ 4. Axios: POST /api/auth/login ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ ]
     |
     +------> [ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ ]
     |           - èªè¨¼æƒ…å ±ã‚’æ¤œè¨¼
     |           - JWT + User ã‚’è¿”ã™
     â†“
[ 5. Axios: æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ (200 OK) ã‚’å—ä¿¡ ]
     â†“
[ 6. React Query: onSuccess ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ ]
     â†“
[ 7. Zustand (authStore): setAuth(...) ã‚’å®Ÿè¡Œ ]
   - isAuthenticated: true
   - user: { ... }
     â†“
[ 8. React: UIãŒãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æ›´æ–° ]
   - useAuth ã‚’ä½¿ç”¨ã™ã‚‹å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     â†“
[ 9. React Router (App.tsx) ]
   - isAuthenticated ãŒ true ã«ãªã‚Šã€Navigate ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
     â†“
[ 10. ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ ('/') ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ ]
     â†“
[ 11. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ (DashboardPage) ]
```

---

## 2. JWTèªè¨¼ãƒ•ãƒ­ãƒ¼

### 2.1 ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

```typescript
/**
 * ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®å®Œå…¨ãªæµã‚Œ
 * 
 * 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLoginPageã§ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
 * 2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã« useAuth().login(data) ã‚’å‘¼ã³å‡ºã™
 * 3. loginé–¢æ•°ã¯å†…éƒ¨ã§ useLogin() Mutation ã‚’å®Ÿè¡Œã—ã€/api/auth/login ã«POST
 * 4. ã‚µãƒ¼ãƒãƒ¼ãŒèªè¨¼æƒ…å ±ã‚’æ¤œè¨¼ã—ã€æˆåŠŸæ™‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
 * 5. useLogin Mutationã®onSuccessã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã€authStoreã®çŠ¶æ…‹ã¨localStorageã‚’æ›´æ–°
 * 6. useAuth().login() ãŒæˆåŠŸã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«Dashboardãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
 */

// src/hooks/useAuth.ts
export const useAuth = () => {
    const navigate = useNavigate();
    const { user, isAuthenticated, isLoading } = useAuthStore();
    const loginMutation = useLogin(); // React Query Mutation Hook

    const login = useCallback(async (credentials: LoginRequest) => {
        try {
            await loginMutation.mutateAsync(credentials);
            navigate('/'); // æˆåŠŸå¾Œãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        } catch (error: any) {
            throw new Error(error.response?.data?.message || 'Login failed');
        }
    }, [loginMutation, navigate]);

    // ... logout, hasRoleãªã©ã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰
};


// src/pages/auth/LoginPage.tsx
function LoginPage() {
  const { login, isLoading, loginError } = useAuth();
  const form = useForm<LoginRequest>();

  const onSubmit = async (data: LoginRequest) => {
    try {
      await login(data);
      // æˆåŠŸæ™‚ã¯useAuthãƒ•ãƒƒã‚¯å†…ã§è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    } catch (error) {
      toast.error(getErrorMessage(error));
    }
  };

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      {/* ... form fields ... */}
      <Button type="submit" disabled={isLoading}>
        {isLoading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
      </Button>
    </form>
  );
}
```

### 2.2 ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•æ›´æ–°ãƒ•ãƒ­ãƒ¼

ï¼ˆå¤‰æ›´ãªã—ï¼‰

### 2.3 ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ­ãƒ¼

ï¼ˆå¤‰æ›´ãªã—ï¼‰

---

## 3. ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

ï¼ˆå¤‰æ›´ãªã—ï¼‰

---

## 4. ZustandçŠ¶æ…‹ç®¡ç†

### 4.1 authStoreå®Œå…¨å®Ÿè£…

ï¼ˆå¤‰æ›´ãªã—ï¼‰

### 4.2 useAuth ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯

```typescript
/**
 * src/hooks/useAuth.ts
 * 
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®èªè¨¼é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã€‚
 * çŠ¶æ…‹ç®¡ç†(Zustand)ã€APIå‘¼ã³å‡ºã—(React Query)ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°(React Router)ã‚’çµ±åˆã—ã€
 * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
 */

import { useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuthStore } from '@/stores/authStore';
import { useLogin, useLogout } from '@/api/authApi';
import type { LoginRequest } from '@/types/auth';

export const useAuth = () => {
    const navigate = useNavigate();

    // StoreçŠ¶æ…‹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    const { user, isAuthenticated, isLoading } = useAuthStore();
    const { clearAuth } = useAuthStore();

    // API Hooks (React Query)
    const loginMutation = useLogin();
    const logoutMutation = useLogout();

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    const login = useCallback(async (credentials: LoginRequest) => {
        try {
            await loginMutation.mutateAsync(credentials);
            navigate('/'); // æˆåŠŸå¾Œãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        } catch (error: any) {
            throw new Error(error.response?.data?.message || 'Login failed');
        }
    }, [loginMutation, navigate]);

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    const logout = useCallback(async () => {
        try {
            await logoutMutation.mutateAsync();
        } catch (error) {
            console.error('Logout request failed, clearing local state anyway');
        }
    }, [logoutMutation]);

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    const hasRole = useCallback((roles: string | string[]) => {
        if (!user) return false;
        const allowedRoles = Array.isArray(roles) ? roles : [roles];
        return allowedRoles.includes(user.role);
    }, [user]);

    // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    const isAdmin = useCallback(() => {
        return hasRole('ADMIN');
    }, [hasRole]);

    return {
        // çŠ¶æ…‹
        user,
        isAuthenticated,
        isLoading: isLoading || loginMutation.isPending,

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        login,
        logout,

        // æ¨©é™ãƒã‚§ãƒƒã‚¯
        hasRole,
        isAdmin,
    };
};
```

---

## 5. ProtectedRouteå®Ÿè£…

### 5.1 ProtectedRouteã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
/**
 * src/components/common/ProtectedRoute.tsx
 * 
 * èªè¨¼ãƒ»èªå¯ã‚¬ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚
 * ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒèªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®å”¯ä¸€ã®åˆ¶å¾¡ç‚¹ã§ã™ã€‚
 * - èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æœªèªè¨¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
 * - è¦æ±‚ã•ã‚ŒãŸæ¨©é™ï¼ˆãƒ­ãƒ¼ãƒ«ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¨©é™ãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‘ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚
 */

import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '@/hooks';
import { Loader2 } from 'lucide-react';

interface ProtectedRouteProps {
    children: React.ReactNode;
    requiredRoles?: string[]; // å¿…è¦ãªæ¨©é™ (æœªæŒ‡å®š=ãƒ­ã‚°ã‚¤ãƒ³ã®ã¿å¿…è¦)
    fallbackPath?: string;    // æ¨©é™ä¸è¶³æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({
    children,
    requiredRoles,
    fallbackPath = '/'
}) => {
    const location = useLocation();
    const { isAuthenticated, isLoading, hasRole } = useAuth(); // useAuthã‚’ç›´æ¥ä½¿ç”¨

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤º
    if (isLoading) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <Loader2 className="h-8 w-8 animate-spin" />
            </div>
        );
    }

    // æœªèªè¨¼æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (!isAuthenticated) {
        return (
            <Navigate
                to="/login"
                state={{ from: location }} // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®æˆ»ã‚Šå…ˆã‚’ä¿å­˜
                replace
            />
        );
    }

    // æ¨©é™ä¸è¶³æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if (requiredRoles && !hasRole(requiredRoles)) {
        return <Navigate to={fallbackPath} replace />;
    }

    // èªè¨¼ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯é€šéæ™‚ã¯å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤º
    return <>{children}</>;
};

export default ProtectedRoute;
```

### 5.2 ~~useRequireAuth ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯~~ (å»ƒæ­¢)

ã“ã®ãƒ•ãƒƒã‚¯ã¯ `ProtectedRoute` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒ­ã‚¸ãƒƒã‚¯ãŒé‡è¤‡ã—ã¦ã„ãŸãŸã‚ã€å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã¯ã™ã¹ã¦ `ProtectedRoute` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«çµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### 5.3 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šä¾‹

ï¼ˆå¤‰æ›´ãªã— - `App.tsx`ã®æ§‹é€ ã¯å¼•ãç¶šãæœ‰åŠ¹ã§ã™ï¼‰

```typescript
/**
 * src/App.tsx
 * 
 * ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
 */
function App() {
  return (
    <Routes>
      {/* ... å…¬é–‹ãƒ«ãƒ¼ãƒˆ ... */}

      {/* ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ */}
      <Route
        path="/*"
        element={
          <ProtectedRoute>
            <Layout />
          </ProtectedRoute>
        }
      >
        {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */}
        <Route index element={<DashboardPage />} />

        {/* å•†å“ç®¡ç†: ä½œæˆãƒ»ç·¨é›† (ç®¡ç†è€…æ¨©é™å¿…è¦) */}
        <Route
          path="foods/new"
          element={
            <ProtectedRoute requiredRoles={['ADMIN']}>
              <FoodFormPage />
            </ProtectedRoute>
          }
        />
        {/* ...ãã®ä»–ã®ä¿è­·ã•ã‚ŒãŸå­ãƒ«ãƒ¼ãƒˆ... */}
      </Route>
    </Routes>
  );
}
```

---

## 6. æ¨©é™åˆ¶å¾¡ï¼ˆRBACï¼‰

ï¼ˆå¤‰æ›´ãªã—ï¼‰

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

ï¼ˆå¤‰æ›´ãªã—ï¼‰

---

## ğŸ“š å‚è€ƒè³‡æ–™

ï¼ˆå¤‰æ›´ãªã—ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2025-10-18
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0
