# 07-çŠ¶æ…‹ç®¡ç†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

> Food-Del-Dashboard ã® Zustand + TanStack Query ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†æˆ¦ç•¥

## ğŸ“‹ ç›®æ¬¡

1. [çŠ¶æ…‹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#çŠ¶æ…‹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [ZustandçŠ¶æ…‹ç®¡ç†](#zustandçŠ¶æ…‹ç®¡ç†)
3. [TanStack Queryã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°](#tanstack-queryã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°)
4. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥)
5. [æ¥½è¦³çš„æ›´æ–°](#æ¥½è¦³çš„æ›´æ–°)
6. [ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°](#ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)

---

## 1. çŠ¶æ…‹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 çŠ¶æ…‹ã®åˆ†é¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              çŠ¶æ…‹ç®¡ç†ã®éšå±¤æ§‹é€                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ ãƒ­ãƒ¼ã‚«ãƒ«UIçŠ¶æ…‹ (useState, useReducer)
   â€¢ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤
   â€¢ ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰çŠ¶æ…‹
   â€¢ ã‚¿ãƒ–ã®é¸æŠçŠ¶æ…‹
   â€¢ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼
   
   ä¾‹: const [isOpen, setIsOpen] = useState(false);

2ï¸âƒ£ ã‚°ãƒ­ãƒ¼ãƒãƒ«UIçŠ¶æ…‹ (Zustand)
   â€¢ èªè¨¼æƒ…å ±ï¼ˆuser, tokenï¼‰
   â€¢ ãƒ†ãƒ¼ãƒè¨­å®šï¼ˆlight/darkï¼‰
   â€¢ ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰çŠ¶æ…‹
   â€¢ é€šçŸ¥è¨­å®š
   
   ä¾‹: const { user } = useAuthStore();

3ï¸âƒ£ ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ (TanStack Query)
   â€¢ å•†å“ãƒ‡ãƒ¼ã‚¿
   â€¢ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
   â€¢ ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿
   â€¢ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆ
   
   ä¾‹: const { data } = useFoods();
```

### 1.2 è¨­è¨ˆåŸå‰‡

```typescript
/**
 * çŠ¶æ…‹ç®¡ç†ã®é¸æŠåŸºæº–
 */

// âœ… ãƒ­ãƒ¼ã‚«ãƒ«UIçŠ¶æ…‹: useState/useReducer
// - å˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å®Œçµ
// - ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å‚ç…§ä¸è¦
function Modal() {
  const [isOpen, setIsOpen] = useState(false);
  return <Dialog open={isOpen} onOpenChange={setIsOpen} />;
}

// âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«UIçŠ¶æ…‹: Zustand
// - è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å…±æœ‰
// - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ°¸ç¶š
// - ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ä¸è¦
const useAuthStore = create<AuthState>((set) => ({
  user: null,
  login: (user) => set({ user }),
  logout: () => set({ user: null }),
}));

// âœ… ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹: TanStack Query
// - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
// - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ãŒå¿…è¦
// - è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«åŒæœŸ
export const useFoods = () => {
  return useQuery({
    queryKey: ['foods'],
    queryFn: fetchFoods,
    staleTime: 5 * 60 * 1000,
  });
};
```

---

## 2. ZustandçŠ¶æ…‹ç®¡ç†

### 2.1 authStoreï¼ˆèªè¨¼çŠ¶æ…‹ï¼‰

```typescript
/**
 * src/stores/authStore.ts
 * 
 * èªè¨¼çŠ¶æ…‹ç®¡ç†
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 * - JWT Token
 * - localStorageæ°¸ç¶šåŒ–
 */

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import type { User } from '@/types';

interface AuthState {
  // çŠ¶æ…‹
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  login: (user: User, accessToken: string, refreshToken: string) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
  updateAccessToken: (accessToken: string) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      // åˆæœŸçŠ¶æ…‹
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,

      // ãƒ­ã‚°ã‚¤ãƒ³
      login: (user, accessToken, refreshToken) => {
        set({
          user,
          accessToken,
          refreshToken,
          isAuthenticated: true,
        });
      },

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      logout: () => {
        set({
          user: null,
          accessToken: null,
          refreshToken: null,
          isAuthenticated: false,
        });
      },

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
      updateUser: (updatedUser) => {
        const currentUser = get().user;
        if (currentUser) {
          set({ user: { ...currentUser, ...updatedUser } });
        }
      },

      // AccessTokenæ›´æ–°
      updateAccessToken: (accessToken) => {
        set({ accessToken });
      },
    }),
    {
      name: 'auth-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        user: state.user,
        accessToken: state.accessToken,
        refreshToken: state.refreshToken,
        isAuthenticated: state.isAuthenticated,
      }),
    }
  )
);

// ä½¿ç”¨ä¾‹
function Header() {
  const { user, logout } = useAuthStore();
  
  return (
    <div>
      <span>ã‚ˆã†ã“ãã€{user?.name}ã•ã‚“</span>
      <button onClick={logout}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  );
}
```

### 2.2 Zustandã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```typescript
/**
 * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯å¸¸ã«é–¢æ•°ã¨ã—ã¦å®šç¾©
 */

// âœ… æ¨å¥¨: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’ä½¿ç”¨
const useStore = create<State>((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
  decrement: () => set((state) => ({ count: state.count - 1 })),
}));

// âŒ é¿ã‘ã‚‹ã¹ã: ç›´æ¥setã‚’å¤–éƒ¨ã§å‘¼ã¶
function Component() {
  const store = useStore();
  // store.set() ã¯é¿ã‘ã‚‹
}

/**
 * Selectorã§å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å–å¾—ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–ï¼‰
 */

// âœ… æ¨å¥¨: Selectorã§å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å–å¾—
function UserName() {
  const userName = useAuthStore((state) => state.user?.name);
  return <span>{userName}</span>;
}

// âŒ éåŠ¹ç‡: Storeå…¨ä½“ã‚’å–å¾—
function UserName() {
  const store = useAuthStore();  // å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  return <span>{store.user?.name}</span>;
}

/**
 * DevToolsã§çŠ¶æ…‹ãƒ‡ãƒãƒƒã‚°
 */

import { devtools } from 'zustand/middleware';

const useStore = create<State>()(
  devtools(
    (set) => ({
      // ... state
    }),
    { name: 'AuthStore' }  // DevToolsè¡¨ç¤ºå
  )
);
```

---

## 3. TanStack Queryã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

### 3.1 Query Keyè¨­è¨ˆ

```typescript
/**
 * Query Keyã®å‘½åè¦å‰‡
 * 
 * åŸå‰‡:
 * - éšå±¤çš„ãªé…åˆ—æ§‹é€ 
 * - ä¸€æ„æ€§ã‚’ä¿è¨¼
 * - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹
 */

// âœ… æ¨å¥¨: éšå±¤çš„ãªKeyæ§‹é€ 
const queryKey = ['foods'];                           // ä¸€è¦§
const queryKey = ['foods', id];                       // è©³ç´°
const queryKey = ['foods', 'list', { page, search }]; // ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãä¸€è¦§
const queryKey = ['foods', id, 'reviews'];            // é–¢é€£ãƒ‡ãƒ¼ã‚¿

// âŒ é¿ã‘ã‚‹ã¹ã: ãƒ•ãƒ©ãƒƒãƒˆãªKey
const queryKey = ['foodList'];
const queryKey = ['food-123'];
const queryKey = ['foodReviews'];

/**
 * Query Key Factory ãƒ‘ã‚¿ãƒ¼ãƒ³
 */

// src/api/foodsApi.ts
export const foodKeys = {
  all: ['foods'] as const,
  lists: () => [...foodKeys.all, 'list'] as const,
  list: (filters: FoodFilters) => [...foodKeys.lists(), filters] as const,
  details: () => [...foodKeys.all, 'detail'] as const,
  detail: (id: number) => [...foodKeys.details(), id] as const,
};

// ä½¿ç”¨ä¾‹
export const useFoods = (filters: FoodFilters) => {
  return useQuery({
    queryKey: foodKeys.list(filters),  // ['foods', 'list', { page: 1, search: '' }]
    queryFn: () => fetchFoods(filters),
  });
};

export const useFood = (id: number) => {
  return useQuery({
    queryKey: foodKeys.detail(id),  // ['foods', 'detail', 123]
    queryFn: () => fetchFood(id),
  });
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–æ™‚
queryClient.invalidateQueries({ queryKey: foodKeys.all });     // å…¨ã¦ã®foodsã‚¯ã‚¨ãƒª
queryClient.invalidateQueries({ queryKey: foodKeys.lists() }); // ä¸€è¦§ã®ã¿
```

### 3.2 staleTime ã¨ cacheTime

```typescript
/**
 * staleTime: ãƒ‡ãƒ¼ã‚¿ãŒ"æ–°é®®"ã¨ã¿ãªã•ã‚Œã‚‹æ™‚é–“
 * cacheTime: ãƒ¡ãƒ¢ãƒªå†…ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒã™ã‚‹æ™‚é–“
 */

// âœ… ãƒ‡ãƒ¼ã‚¿ç‰¹æ€§ã«å¿œã˜ãŸè¨­å®š
export const useFoods = () => {
  return useQuery({
    queryKey: ['foods'],
    queryFn: fetchFoods,
    staleTime: 5 * 60 * 1000,   // 5åˆ†é–“ã¯æ–°é®®ï¼ˆå†ãƒ•ã‚§ãƒƒãƒã—ãªã„ï¼‰
    gcTime: 10 * 60 * 1000,     // 10åˆ†é–“ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
  });
};

// é »ç¹ã«æ›´æ–°ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿
export const useOrders = () => {
  return useQuery({
    queryKey: ['orders'],
    queryFn: fetchOrders,
    staleTime: 1 * 60 * 1000,   // 1åˆ†
    gcTime: 5 * 60 * 1000,
  });
};

// ã»ã¼é™çš„ãªãƒ‡ãƒ¼ã‚¿
export const useCategories = () => {
  return useQuery({
    queryKey: ['categories'],
    queryFn: fetchCategories,
    staleTime: 10 * 60 * 1000,  // 10åˆ†
    gcTime: 30 * 60 * 1000,
  });
};

/**
 * è¨­å®šå€¤ã®æ„å‘³
 */

// staleTime: 0 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
//   â†’ å¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒï¼ˆãƒšãƒ¼ã‚¸é·ç§»ã®ãŸã³ã«å†å–å¾—ï¼‰

// staleTime: Infinity
//   â†’ æ‰‹å‹•ã§ invalidate ã™ã‚‹ã¾ã§å†ãƒ•ã‚§ãƒƒãƒã—ãªã„

// cacheTime: 5 * 60 * 1000 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
//   â†’ 5åˆ†é–“ä½¿ç”¨ã•ã‚Œãªã‹ã£ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å‰Šé™¤
```

### 3.3 QueryClientã®è¨­å®š

```typescript
/**
 * src/lib/queryClient.tsx
 * 
 * TanStack Query ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
 */

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®staleTime
      staleTime: 5 * 60 * 1000,  // 5åˆ†
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®cacheTime
      gcTime: 10 * 60 * 1000,    // 10åˆ†
      
      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å†å–å¾—
      refetchOnWindowFocus: true,
      
      // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«å†å–å¾—
      refetchOnMount: true,
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®å†è©¦è¡Œ
      retry: 1,
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®å†è©¦è¡Œé–“éš”
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    },
    mutations: {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®å†è©¦è¡Œãªã—
      retry: false,
    },
  },
});

// ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
export function QueryProvider({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

---

## 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### 4.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆInvalidationï¼‰
 * 
 * ç”¨é€”: ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤å¾Œã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ€æ–°åŒ–
 */

import { useMutation, useQueryClient } from '@tanstack/react-query';

export const useCreateFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateFoodRequest) => {
      return httpClient.post('/api/foods/create', data);
    },
    onSuccess: () => {
      // å•†å“ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ– â†’ è‡ªå‹•çš„ã«å†å–å¾—
      queryClient.invalidateQueries({ queryKey: ['foods'] });
      
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã‚‚æ›´æ–°
      queryClient.invalidateQueries({ queryKey: ['dashboard'] });
    },
  });
};

export const useUpdateFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: UpdateFoodRequest }) => {
      return httpClient.patch(`/api/foods/update/${id}`, data);
    },
    onSuccess: (response, { id }) => {
      // ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
      queryClient.invalidateQueries({ queryKey: ['foods', 'list'] });
      
      // è©³ç´°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
      queryClient.invalidateQueries({ queryKey: ['foods', 'detail', id] });
    },
  });
};

export const useDeleteFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: number) => {
      return httpClient.delete(`/api/foods/delete/${id}`);
    },
    onSuccess: (response, id) => {
      // ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
      queryClient.invalidateQueries({ queryKey: ['foods', 'list'] });
      
      // è©³ç´°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
      queryClient.removeQueries({ queryKey: ['foods', 'detail', id] });
    },
  });
};
```

### 4.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç›´æ¥æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç›´æ¥æ›´æ–°ï¼ˆsetQueryDataï¼‰
 * 
 * ç”¨é€”: ç„¡é§„ãªå†å–å¾—ã‚’é¿ã‘ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç›´æ¥æ›´æ–°
 */

export const useCreateFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateFoodRequest) => {
      return httpClient.post<Food>('/api/foods/create', data);
    },
    onSuccess: (newFood) => {
      // ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æ–°ã—ã„å•†å“ã‚’è¿½åŠ 
      queryClient.setQueryData<Food[]>(['foods', 'list'], (oldData) => {
        if (!oldData) return [newFood];
        return [newFood, ...oldData];
      });
      
      // è©³ç´°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚‚ä¿å­˜
      queryClient.setQueryData(['foods', 'detail', newFood.id], newFood);
    },
  });
};
```

### 4.3 ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
/**
 * ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒï¼ˆPrefetchï¼‰
 * 
 * ç”¨é€”: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 */

import { useQueryClient } from '@tanstack/react-query';

function FoodList() {
  const queryClient = useQueryClient();
  const { data: foods } = useFoods();

  // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼æ™‚ã«è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
  const handleMouseEnter = async (foodId: number) => {
    await queryClient.prefetchQuery({
      queryKey: ['foods', 'detail', foodId],
      queryFn: () => fetchFood(foodId),
      staleTime: 5 * 60 * 1000,
    });
  };

  return (
    <div>
      {foods?.map((food) => (
        <div
          key={food.id}
          onMouseEnter={() => handleMouseEnter(food.id)}
        >
          <Link to={`/foods/${food.id}`}>{food.name}</Link>
        </div>
      ))}
    </div>
  );
}
```

---

## 5. æ¥½è¦³çš„æ›´æ–°

### 5.1 æ¥½è¦³çš„æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
/**
 * æ¥½è¦³çš„æ›´æ–°ï¼ˆOptimistic Updateï¼‰
 * 
 * ç”¨é€”: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‰ã«UIã‚’å³åº§ã«æ›´æ–°
 * ãƒ¡ãƒªãƒƒãƒˆ: UXãŒåŠ‡çš„ã«å‘ä¸Š
 * ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãŒå¿…è¦
 */

export const useUpdateFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: UpdateFoodRequest }) => {
      return httpClient.patch(`/api/foods/update/${id}`, data);
    },
    
    // æ¥½è¦³çš„æ›´æ–°: ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã«UIã‚’æ›´æ–°
    onMutate: async ({ id, data }) => {
      // 1. é€²è¡Œä¸­ã®ã‚¯ã‚¨ãƒªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç«¶åˆã‚’é¿ã‘ã‚‹ï¼‰
      await queryClient.cancelQueries({ queryKey: ['foods'] });
      
      // 2. ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
      const previousFoods = queryClient.getQueryData<Food[]>(['foods', 'list']);
      const previousFood = queryClient.getQueryData<Food>(['foods', 'detail', id]);
      
      // 3. æ¥½è¦³çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
      queryClient.setQueryData<Food[]>(['foods', 'list'], (old) => {
        if (!old) return old;
        return old.map((food) =>
          food.id === id ? { ...food, ...data } : food
        );
      });
      
      queryClient.setQueryData<Food>(['foods', 'detail', id], (old) => {
        if (!old) return old;
        return { ...old, ...data };
      });
      
      // 4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
      return { previousFoods, previousFood };
    },
    
    // ã‚¨ãƒ©ãƒ¼æ™‚: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    onError: (err, variables, context) => {
      if (context?.previousFoods) {
        queryClient.setQueryData(['foods', 'list'], context.previousFoods);
      }
      if (context?.previousFood) {
        queryClient.setQueryData(['foods', 'detail', variables.id], context.previousFood);
      }
      toast.error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    },
    
    // æˆåŠŸæ™‚: ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ç¢ºå®š
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['foods'] });
      toast.success('æ›´æ–°ã—ã¾ã—ãŸ');
    },
  });
};
```

### 5.2 æ¥½è¦³çš„å‰Šé™¤

```typescript
export const useDeleteFood = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: number) => {
      return httpClient.delete(`/api/foods/delete/${id}`);
    },
    
    onMutate: async (id) => {
      await queryClient.cancelQueries({ queryKey: ['foods'] });
      
      const previousFoods = queryClient.getQueryData<Food[]>(['foods', 'list']);
      
      // æ¥½è¦³çš„ã«å‰Šé™¤
      queryClient.setQueryData<Food[]>(['foods', 'list'], (old) => {
        if (!old) return old;
        return old.filter((food) => food.id !== id);
      });
      
      return { previousFoods };
    },
    
    onError: (err, id, context) => {
      if (context?.previousFoods) {
        queryClient.setQueryData(['foods', 'list'], context.previousFoods);
      }
      toast.error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    },
    
    onSuccess: () => {
      toast.success('å‰Šé™¤ã—ã¾ã—ãŸ');
    },
  });
};
```

---

## 6. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### 6.1 ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆPollingï¼‰

```typescript
/**
 * å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
 * 
 * ç”¨é€”: æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚ˆã†ãªé »ç¹ã«å¤‰ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿
 */

export const useOrders = () => {
  return useQuery({
    queryKey: ['orders'],
    queryFn: fetchOrders,
    refetchInterval: 30 * 1000,  // 30ç§’ã”ã¨ã«å†å–å¾—
    refetchIntervalInBackground: false,  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯åœæ­¢
  });
};

// æ¡ä»¶ä»˜ããƒãƒ¼ãƒªãƒ³ã‚°
export const useOrder = (id: number) => {
  const { data: order } = useQuery({
    queryKey: ['orders', 'detail', id],
    queryFn: () => fetchOrder(id),
    refetchInterval: (data) => {
      // PENDINGã¾ãŸã¯PROCESSINGã®å ´åˆã®ã¿ãƒãƒ¼ãƒªãƒ³ã‚°
      if (data?.status === 'PENDING' || data?.status === 'PROCESSING') {
        return 10 * 1000;  // 10ç§’ã”ã¨
      }
      return false;  // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
    },
  });

  return { order };
};
```

### 6.2 è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒƒã‚¯

```typescript
/**
 * src/hooks/useDashboardAutoRefresh.ts
 * 
 * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è‡ªå‹•æ›´æ–°ãƒ•ãƒƒã‚¯
 */

import { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';

export function useDashboardAutoRefresh(interval = 60 * 1000) {
  const queryClient = useQueryClient();

  useEffect(() => {
    const timer = setInterval(() => {
      console.log('[Auto Refresh] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°');
      
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–¢é€£ã®ã‚¯ã‚¨ãƒªã‚’å…¨ã¦ç„¡åŠ¹åŒ–
      queryClient.invalidateQueries({ queryKey: ['dashboard'] });
      queryClient.invalidateQueries({ queryKey: ['orders', 'stats'] });
    }, interval);

    return () => clearInterval(timer);
  }, [queryClient, interval]);
}

// ä½¿ç”¨ä¾‹
function DashboardPage() {
  useDashboardAutoRefresh(60 * 1000);  // 1åˆ†ã”ã¨
  
  const { data: overview } = useDashboardOverview();
  const { data: sales } = useDashboardSales();
  
  return <div>...</div>;
}
```

### 6.3 WebSocketçµ±åˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰

```typescript
/**
 * WebSocketã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
 */

import { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { io } from 'socket.io-client';

export function useWebSocketSync() {
  const queryClient = useQueryClient();

  useEffect(() => {
    const socket = io('ws://localhost:5000');

    // æ–°è¦æ³¨æ–‡é€šçŸ¥
    socket.on('order:created', (order) => {
      console.log('[WebSocket] æ–°è¦æ³¨æ–‡:', order);
      
      // æ³¨æ–‡ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
      queryClient.setQueryData<Order[]>(['orders'], (old) => {
        if (!old) return [order];
        return [order, ...old];
      });
      
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆã‚’æ›´æ–°
      queryClient.invalidateQueries({ queryKey: ['dashboard'] });
    });

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    socket.on('order:updated', (order) => {
      console.log('[WebSocket] æ³¨æ–‡æ›´æ–°:', order);
      
      // è©²å½“æ³¨æ–‡ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
      queryClient.setQueryData(['orders', 'detail', order.id], order);
      queryClient.invalidateQueries({ queryKey: ['orders', 'list'] });
    });

    return () => {
      socket.disconnect();
    };
  }, [queryClient]);
}
```

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 Selectæ©Ÿèƒ½ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```typescript
/**
 * Selectorã§å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—
 */

// âŒ éåŠ¹ç‡: ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’å–å¾—ï¼ˆå…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
function FoodName() {
  const { data: food } = useFood(123);
  return <span>{food?.name}</span>;
}

// âœ… åŠ¹ç‡çš„: Selectæ©Ÿèƒ½ã§å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿å–å¾—
function FoodName() {
  const { data: name } = useFood(123, {
    select: (food) => food.name,
  });
  return <span>{name}</span>;
}

// è¤‡æ•°ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é¸æŠ
function FoodCard() {
  const { data } = useFood(123, {
    select: (food) => ({
      name: food.name,
      price: food.price,
      image: food.image,
    }),
  });
  
  return (
    <div>
      <img src={data?.image} />
      <h3>{data?.name}</h3>
      <p>Â¥{data?.price}</p>
    </div>
  );
}
```

### 7.2 useMemoã§ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’æœ€é©åŒ–

```typescript
/**
 * ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‡¦ç†ã‚’ãƒ¡ãƒ¢åŒ–
 */

import { useMemo } from 'react';

function FoodListPage() {
  const { data: foods } = useFoods();
  const [searchQuery, setSearchQuery] = useState('');

  // âœ… useMemoã§æ¤œç´¢çµæœã‚’ãƒ¡ãƒ¢åŒ–
  const filteredFoods = useMemo(() => {
    if (!foods) return [];
    return foods.filter((food) =>
      food.name.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }, [foods, searchQuery]);

  return (
    <div>
      <input
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
      />
      {filteredFoods.map((food) => <FoodCard key={food.id} food={food} />)}
    </div>
  );
}
```

### 7.3 Suspenseã§ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—

```typescript
/**
 * Suspenseã§è¤‡æ•°ã‚¯ã‚¨ãƒªã‚’ä¸¦åˆ—å®Ÿè¡Œ
 */

import { Suspense } from 'react';
import { useSuspenseQuery } from '@tanstack/react-query';

function DashboardContent() {
  const { data: overview } = useSuspenseQuery({
    queryKey: ['dashboard', 'overview'],
    queryFn: fetchOverview,
  });
  
  const { data: sales } = useSuspenseQuery({
    queryKey: ['dashboard', 'sales'],
    queryFn: fetchSales,
  });
  
  return (
    <div>
      <StatsCard {...overview} />
      <SalesChart data={sales} />
    </div>
  );
}

function DashboardPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <DashboardContent />
    </Suspense>
  );
}
```

### 7.4 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºç®¡ç†

```typescript
/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã—ã¦ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æœ€é©åŒ–
 */

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      gcTime: 5 * 60 * 1000,  // 5åˆ†é–“ä½¿ç”¨ã•ã‚Œãªã‘ã‚Œã°å‰Šé™¤
    },
  },
});

// æ‰‹å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
function clearOldCache() {
  queryClient.clear();  // å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  
  // ç‰¹å®šã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ã‚¯ãƒªã‚¢
  queryClient.removeQueries({ queryKey: ['foods'], exact: false });
}
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [TanStack Queryå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://tanstack.com/query/latest)
- [Zustandå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.pmnd.rs/zustand)
- [React Performance Optimization](https://react.dev/learn/render-and-commit)
- [Effective React Query Keys](https://tkdodo.eu/blog/effective-react-query-keys)

---

**æœ€çµ‚æ›´æ–°**: 2025-10-15  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
