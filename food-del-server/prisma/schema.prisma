// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User table / ユーザーテーブル
model User {
  id         Int      @id @default(autoincrement())
  name       String   // User name / ユーザー名
  email      String   @unique // Email address / メールアドレス
  password   String   // Password (encrypted) / パスワード（暗号化）
  role       String   @default("customer") // customer, admin, staff / 顧客、管理者、スタッフ
  phone      String?  // Phone number / 電話番号
  created_at DateTime @default(now()) // Created at / 作成日時
  updated_at DateTime @updatedAt // Updated at / 更新日時

  // Relations / リレーション
  cart               Cart?                 // User cart / ユーザーのカート
  orders             Order[]               // User orders / ユーザーの注文履歴
  status_updates     OrderStatusHistory[]  // Status updates by this user / このユーザーが更新したステータス履歴
  inventory_changes  InventoryHistory[]    // Inventory changes made by this user / このユーザーが行った在庫変更

  @@map("users")
}

// Category table / カテゴリテーブル
model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Category name / カテゴリ名
  description String?  // Category description / カテゴリ説明
  status      Boolean  @default(true) // Category status / カテゴリ状態
  created_at  DateTime @default(now()) // Created at / 作成日時
  updated_at  DateTime @updatedAt // Updated at / 更新日時
  
  // Relations / リレーション
  foods       Food[]   // Foods in this category / このカテゴリの食品
  
  @@map("categories")
}

// Food table / 食品テーブル
model Food {
  id          Int      @id @default(autoincrement())
  name        String   // Food name / 食品名
  description String   // Food description / 食品説明
  price       Float    // Food price / 食品価格
  category_id Int      // Category ID / カテゴリID
  image_path  String   // Image path / 画像パス
  status      Boolean  @default(true) // Food status / 食品状態

  // Inventory management fields / 在庫管理フィールド
  stock       Int      @default(0) // Available stock / 利用可能在庫
  reserved    Int      @default(0) // Reserved stock / 予約済み在庫
  min_stock   Int      @default(0) // Minimum stock threshold / 最小在庫閾値
  version     Int      @default(1) // Optimistic lock version / 楽観的ロックバージョン

  created_at  DateTime @default(now()) // Created at / 作成日時
  updated_at  DateTime @updatedAt // Updated at / 更新日時

  // Relations / リレーション
  category         Category           @relation(fields: [category_id], references: [id]) // Food category / 食品カテゴリ
  cart_items       CartItem[]         // Cart items / カートアイテム
  order_items      OrderItem[]        // Order items / 注文アイテム
  inventory_history InventoryHistory[] // Inventory history / 在庫履歴

  @@map("foods")
}

// Cart table / カートテーブル
model Cart {
  id         Int      @id @default(autoincrement())
  user_id    Int      @unique  // User ID (One-to-One) / ユーザーID（1対1）
  created_at DateTime @default(now()) // Created at / 作成日時
  updated_at DateTime @updatedAt // Updated at / 更新日時
  
  // Relations / リレーション
  user       User       @relation(fields: [user_id], references: [id]) // Cart owner / カート所有者
  cart_items CartItem[] // Items in cart / カート内アイテム
  
  @@map("carts")
}

// Cart item table / カートアイテムテーブル
model CartItem {
  id       Int @id @default(autoincrement())
  cart_id  Int // Cart ID / カートID
  food_id  Int // Food ID / 食品ID
  quantity Int @default(1) // Quantity / 数量
  
  // Relations / リレーション
  cart     Cart @relation(fields: [cart_id], references: [id]) // Parent cart / 親カート
  food     Food @relation(fields: [food_id], references: [id]) // Food item / 食品アイテム
  
  @@unique([cart_id, food_id]) // One food per cart / カートあたり1つの食品
  @@map("cart_items")
}

// Order table / 注文テーブル
model Order {
  id               Int      @id @default(autoincrement())
  user_id          Int      // User ID / ユーザーID
  total_amount     Float    // Total amount / 合計金額
  status           String   @default("pending") // pending, confirmed, preparing, delivery, completed, cancelled / 待機中、確認済み、準備中、配送中、完了、キャンセル
  delivery_address String   // Delivery address / 配送先住所
  phone            String   // Contact phone / 連絡先電話番号
  notes            String?  // Order notes / 注文メモ
  order_date       DateTime @default(now()) // Order date / 注文日時
  updated_at       DateTime @updatedAt // Updated at / 更新日時

  // Relations / リレーション
  user             User                  @relation(fields: [user_id], references: [id]) // Order owner / 注文者
  order_items      OrderItem[]           // Items in order / 注文アイテム
  status_history   OrderStatusHistory[]  // Status change history / ステータス変更履歴
  inventory_history InventoryHistory[]   // Related inventory changes / 関連在庫変更

  @@map("orders")
}

// Order item table / 注文アイテムテーブル
model OrderItem {
  id       Int   @id @default(autoincrement())
  order_id Int   // Order ID / 注文ID
  food_id  Int   // Food ID / 食品ID
  quantity Int   // Quantity / 数量
  price    Float // Price at order time / 注文時の価格

  // Relations / リレーション
  order    Order @relation(fields: [order_id], references: [id]) // Parent order / 親注文
  food     Food  @relation(fields: [food_id], references: [id]) // Food item / 食品アイテム

  @@map("order_items")
}

// Order status history table / 注文ステータス履歴テーブル
model OrderStatusHistory {
  id              Int      @id @default(autoincrement())
  order_id        Int      // Order ID / 注文ID
  previous_status String   // Previous status / 前のステータス
  new_status      String   // New status / 新しいステータス
  updated_by      Int      // Updated by user ID / 更新者のユーザーID
  updated_at      DateTime @default(now()) // Updated at / 更新日時
  note            String?  // Status change note / ステータス変更備考

  // Relations / リレーション
  order           Order    @relation(fields: [order_id], references: [id]) // Parent order / 親注文
  updated_by_user User     @relation(fields: [updated_by], references: [id]) // User who updated / 更新者

  // Indexes for performance / パフォーマンス用インデックス
  @@index([order_id])
  @@index([updated_at])
  @@map("order_status_history")
}

// Inventory history table / 在庫履歴テーブル
model InventoryHistory {
  id              Int      @id @default(autoincrement())
  food_id         Int      // Food ID / 食品ID
  change_type     String   // Change type: add, subtract, reserve, release / 変更種別
  quantity        Int      // Quantity changed / 変更数量
  previous_stock  Int      // Stock before change / 変更前在庫
  new_stock       Int      // Stock after change / 変更後在庫
  order_id        Int?     // Related order ID (optional) / 関連注文ID（任意）
  created_by      Int      // User who made the change / 変更実行者
  created_at      DateTime @default(now()) // Created at / 作成日時
  note            String?  // Additional notes / 追加メモ

  // Relations / リレーション
  food            Food     @relation(fields: [food_id], references: [id]) // Related food / 関連食品
  order           Order?   @relation(fields: [order_id], references: [id]) // Related order / 関連注文
  created_by_user User     @relation(fields: [created_by], references: [id]) // User who created / 作成者

  // Indexes for performance / パフォーマンス用インデックス
  @@index([food_id])
  @@index([created_at])
  @@index([change_type])
  @@map("inventory_history")
}