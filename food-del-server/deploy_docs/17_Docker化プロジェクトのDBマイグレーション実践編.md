# 17. Docker化プロジェクトのDBマイグレーション実践編

## 1. 2つの独立した環境

デバッグプロセスを経て、私たちのプロジェクトは最終的に2つの明確に分離された環境を持つ構成に落ち着きました。この分離を理解することが、正しいマイグレーション戦略の鍵となります。

-   **環境1：ローカル開発環境**
    -   **実行方法**: `food-del-server` ディレクトリで `bun --watch index.ts` を直接実行。
    -   **設定ファイル**: `food-del-server/.env` を使用。
    -   **DB接続**: ホストマシン上で直接、またはローカルにインストールされたPostgreSQLに接続します（例: `...@localhost:5432...`）。

-   **環境2：Dockerコンテナ環境**
    -   **実行方法**: プロジェクトのルートディレクトリで `docker-compose up` を実行。
    -   **設定ファイル**: ルートディレクトリの `.env` と `docker-compose.yml` を使用。
    -   **DB接続**: `server` コンテナが、Dockerの内部ネットワークを通じて `postgres` コンテナに接続します（例: `...@postgres:5432...`）。

## 2. なぜホストからのマイグレーションが問題になるのか？

私たちが直面した問題の一つは、「Docker環境のデータベースに対して、どのように `prisma migrate` を実行するか？」でした。

単純にホストマシン（あなたのPC）のターミナルで `npx prisma migrate dev` を実行すると、Prismaは `food-del-server/.env` ファイルを読み込みます。このファイルは**ローカル開発環境用**に設定されているため、`localhost` のデータベースに接続しようとしてしまいます。これではDocker内のデータベースを操作できません。

一時的にホストの `.env` ファイルをDockerのDBを指すように変更することもできますが、これは環境の分離を破壊する行為であり、混乱を招くため推奨されません。

## 3. ベストプラクティス：`docker-compose exec`

この問題をクリーンに解決するための標準的なベストプラクティスが `docker-compose exec` コマンドです。

### a. コマンドの解説

Docker環境のデータベースをマイグレーションするための正しいコマンドは以下の通りです。

**コマンド:**
```bash
docker-compose exec server bunx prisma migrate dev
```

-   `docker-compose exec`: `docker-compose`に対し、現在実行中のサービスのコンテナ内で、後続のコマンドを実行するように指示します。
-   `server`: `docker-compose.yml`で定義した、コマンドを実行したいサービスの**名前**です。
-   `bunx prisma migrate dev`: `server`コンテナのシェルで**実際に実行されるコマンド**です。

### b. なぜこれが正しいのか？

このアプローチが優れている理由は3つあります。

1.  **環境変数の分離**: コマンドは `server` コンテナ内で実行されるため、`docker-compose.yml` を通じてそのコンテナに注入された環境変数を自動的に使用します。つまり、`DATABASE_URL` は正しく内部の `postgres` サービスを指します。
2.  **ネットワークの分離**: データベースへの接続は、Dockerが管理する安全なプライベートネットワーク内で完結します。ホストのポートマッピングに依存しないため、より安定하고安全です。
3.  **ツールの統一**: `prisma` コマンドは、コンテナ内にインストールされた `node_modules` と `bunx` ランタイムによって実行されます。これにより、コマンドの実行環境とアプリケーションの実行環境が完全に一致し、バージョンの不整合などの問題を回避できます。

## 4. 推奨されるワークフロー

Docker環境で開発やテストを行う際の、推奨される一連の操作フローは以下のようになります。

1.  **サービスを起動する**: （ルートディレクトリで）
    ```bash
    docker-compose up --build -d
    ```

2.  **DBマイグレーションを実行する**: （新しいターミナルで、ルートディレクトリで）
    ```bash
    docker-compose exec server bunx prisma migrate dev
    # または、初期化のみの場合
    # docker-compose exec server bunx prisma db push
    ```

3.  **サービスを停止する**:
    ```bash
    docker-compose down
    ```

4.  **(オプション) 全てをクリーンアップする**:
    ```bash
    docker-compose down -v
    ```

## 5. 結論

`docker-compose exec` は、コンテナ化されたアプリケーションを管理するための強力なツールです。これにより、マイグレーション、データベースのシーディング、デバッグ用のシェルへのアクセスなど、様々な管理タスクを、サービスの実行コンテキスト内で直接実行できます。このアプローチは、ローカル開発環境とコンテナ化された環境のクリーンな分離を維持するための鍵となります。
