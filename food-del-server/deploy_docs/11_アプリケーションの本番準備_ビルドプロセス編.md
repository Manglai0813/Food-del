# 11. アプリケーションの本番準備：ビルドプロセス編

## 1. なぜ「ビルド」が必要なのか？

開発中、私たちは `bun --watch index.ts` のようなコマンドを使い、TypeScriptファイルを直接実行していました。これは変更を即座に反映できるため、開発効率が非常に高いです。

しかし、本番環境ではこの方法は推奨されません。理由は以下の通りです。

-   **パフォーマンス**: TypeScriptを直接実行すると、実行時にリアルタイムでのコンパイル（トランスパイル）が発生します。これはサーバーの起動を遅くし、実行中のパフォーマンスにも若干のオーバーヘッドをもたらします。事前にコンパイル済みの最適化されたJavaScriptを実行する方が高速です。
-   **安定性と依存関係**: 本番環境のコンテナは、可能な限り軽量で、実行に不要なツールを含まないべきです。TypeScriptファイルを直接実行するには、コンテナ内にTypeScriptコンパイラ(`typescript`パッケージ)などの`devDependencies`（開発用依存関係）をインストールする必要がありますが、これらはアプリケーションの実行自体には不要です。

このため、本番環境にデプロイする前には、すべての`.ts`ソースコードを標準的な`.js`ファイルに変換する**「ビルド」**というステップが必要になります。

## 2. `package.json`の修正

ビルドプロセスを導入するため、私たちは `package.json` の `scripts` セクションに2つの新しいコマンドを追加しました。

**修正後の `scripts`:**
```json
"scripts": {
  "dev": "bun --watch index.ts",
  "start": "bun index.ts",
  "build": "bunx tsc && bunx tsc-alias",
  "start:prod": "bun dist/index.js"
}
```

### a. `build` スクリプト

```bash
bun run build
```

このコマンドは、以下の2つの処理を連続して実行します。

1.  **`bunx tsc`**: TypeScriptコンパイラ(`tsc`)を呼び出します。`tsc`は `tsconfig.json` の設定に従って、`src/` ディレクトリ内のすべての `.ts` ファイルを `.js` ファイルにコンパイルし、`dist/` ディレクトリに出力します。
2.  **`bunx tsc-alias`**: `tsc`のコンパイル後、出力された`.js`ファイル内に残っているパスエイリアス（例: `@/services/...`）を、Node.jsが理解できる正しい相対パス（例: `../../services/...`）に置換します。これは、パスエイリアスを使っているプロジェクトを本番環境で実行するために不可欠なステップです。

### b. `start:prod` スクリプト

```bash
bun run start:prod
```

このコマンドは、ビルドによって生成されたアプリケーションの入口ファイル (`dist/index.js`) を直接実行します。`--watch` フラグがないため、不要なファイル監視を行わず、リソースの消費を抑えます。これは本番環境での標準的な起動方法です。

## 3. `tsconfig.json`の修正

`build` スクリプトが正しく機能するために、私たちは `tsconfig.json` の `compilerOptions` を以下のように修正しました。

1.  **`"noEmit": true` を削除**: この行があると、`tsc`は型チェックのみを行い、ファイルを出力しません。これを削除することで、`.js`ファイルが生成されるようになります。
2.  **`"outDir": "./dist"` を追加**: コンパイルされたJavaScriptファイルの出力先を `dist` ディレクトリに指定します。
3.  **`"allowImportingTsExtensions": true` を削除**: このオプションは、`tsc`がJavaScriptを生成するモードとは互換性がないため、削除しました。

**修正後の関連部分:**
```json
{
  "compilerOptions": {
    // ...
    "moduleResolution": "bundler",
    "verbatimModuleSyntax": true,
    "outDir": "./dist", // 出力先を指定
    "rootDir": ".",
    // "noEmit": true, は削除済み
    // "allowImportingTsExtensions": true, は削除済み
    "strict": true,
    // ...
  }
}
```

## 4. 結論

これらの修正により、私たちのプロジェクトは「開発モード」と「本番モード」の二つを持つようになりました。

-   **開発時**: `bun --watch index.ts` で高速なホットリロード開発を行う。
-   **本番デプロイ前**: `bun run build` を実行して、最適化されたポータブルなJavaScriptコードを `dist` ディレクトリに生成する。

この明確な分離は、プロフェッショナルなデプロイワークフローの基礎となります。
