# 16. Dockerランタイムデバッグ手帳

## 1. はじめに

完璧な設定ファイルを作成したとしても、アプリケーションを実行する際には予期せぬ問題が発生することがあります。この文書は、私たちが `docker-compose up` を実行してからアプリケーションが正常に起動するまでに遭遇した、一連のランタイムエラーの診断と解決のプロセスを記録した「故障排除ハンドブック」です。

## 2. ケーススタディ1：ポート衝突

-   **症状**: `docker-compose up` を実行すると、`postgres` コンテナの起動に失敗する。
-   **エラーログ**: `Error ... address already in use ... failed to bind host port for 0.0.0.0:5432`
-   **原因分析**: ホストマシン（あなたのPC）の`5432`番ポートが、既に他のプロセスによって使用されていました。これは、ローカル開発用にインストールされたPostgreSQLが起動していたためです。
-   **解決策**: `docker-compose.yml` ファイルを編集し、`postgres` サービスのポートマッピングを、ホスト側で空いている別のポートに変更しました。

    ```yaml
    # 修正前
    ports:
      - "5432:5432"

    # 修正後
    ports:
      - "5433:5432" # ホスト側のポートを5433に変更
    ```
    この変更に伴い、`prisma migrate` をホストから実行するために `food-del-server/.env` の `DATABASE_URL` のポートも `5433` に更新しました。

## 3. ケーススタディ2：データベース認証失敗 (P1000)

-   **症状**: `prisma db push` を実行すると、認証失敗のエラーが発生する。
-   **エラーログ**: `Error: P1000: Authentication failed ... credentials for fooduser are not valid.`
-   **原因分析**: これは非常に微妙な問題でした。`.env` ファイル内の `POSTGRES_PASSWORD` に、URLエンコードされたパスワード (`...%21%40%23`) を設定していました。
    1.  `postgres` コンテナは、この**エンコードされた文字列そのもの**をパスワードとして初期設定してしまいました。
    2.  一方、`server` コンテナ内のPrismaクライアントは、接続時にこの文字列を**デコード**し、元のパスワード (`...!@#`) でログインしようとしました。
    3.  結果、パスワードが一致せずに認証が失敗しました。
-   **解決策**: 根本的な原因である「エンコーディングの不一致」をなくすため、パスワードを特殊文字を含まないシンプルなもの（例: `fooddelpassword`）に変更しました。これにより、DB初期化時とアプリ接続時の両方で、パスワードの解釈が完全に一致するようになりました。

## 4. ケーススタディ3：Prismaの「幽霊状態」

-   **症状**: `prisma db push` を実行すると、「データベースは既にスキーマと同期済みです」という不可解なメッセージが表示される。
-   **エラーログ**: `The database is already in sync with the Prisma schema.`
-   **原因分析**: Dockerの**名前付きボリュームの永続化**が原因でした。`docker-compose down` コマンドは、デフォルトではコンテナを削除するだけで、`postgres_data` のようなデータボリュームは削除しません。過去の失敗した試行によって、このボリューム内に不完全または破損したデータが残り、Prismaにデータベースが空ではないと誤認させていました。
-   **解決策**: 「核弾頭級」のクリーンアップコマンドを実行し、コンテナとデータボリュームの両方を完全に削除しました。

    **コマンド:**
    ```bash
    docker-compose down -v
    ```
    `-v` フラグが、ボリュームを削除するための鍵となります。これにより、次回 `up` した際に、完全に新しいクリーンなデータベース環境で開始することが保証されました。

## 5. ケーススタディ4：Prismaマイグレーションのタイムアウト (P1002)

-   **症状**: `prisma migrate dev` が「諮問ロック（advisory lock）の取得にタイムアウトしました」というエラーで失敗する。
-   **エラーログ**: `Error: P1002 ... Timed out trying to acquire a postgres advisory lock`
-   **原因分析**: Prismaがマイグレーションを実行する前に、他のプロセスが同時にマイグレーションを実行しないようにデータベース全体にロックをかけようとします。このエラーは、DBコンテナが起動した直後で、まだ内部的に「ウォームアップ」中であり、ロック要求に10秒以内に応答できなかったことが原因である可能性が高いです。
-   **解決策**: 複数の解決策を試しました。
    1.  **再試行**: 単純に同じコマンドを再実行しました（失敗）。
    2.  **DB再起動**: `docker-compose restart postgres` でDBサービスのみを再起動し、古いセッションやロックをクリアしようとしました（失敗）。
    3.  **代替コマンドの使用**: `prisma migrate dev` の代わりに、より直接的な `prisma db push` を使用しました。これは、開発環境の空のDBを初期化するのに適しており、複雑なロックメカニズムを回避できる場合があります。最終的にこのアプローチが成功への道を開きました。

## 6. 結論

コンテナ化されたアプリケーションのデバッグは、コード自体の問題だけでなく、コンテナのライフサイクル、ネットワーキング、ボリュームの永続性、環境変数の注入方法など、エコシステム全体の状態を理解することが重要です。エラーログを注意深く読み、仮説を立て、一つずつ検証していく体系的なアプローチが、問題解決の鍵となります。
