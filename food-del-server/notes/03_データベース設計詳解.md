# 03. データベース設計詳解

## 1. 概要

本文書は、`prisma/schema.prisma` ファイルに定義されているデータモデル、リレーション、および設計思想について詳細に解説します。このスキーマは、アプリケーション全体のデータ構造の「信頼できる唯一の情報源（Single Source of Truth）」です。

-   **ORM**: Prisma
-   **データベース**: PostgreSQL

## 2. モデル詳解

### a. `User` (ユーザー)

ユーザー情報を格納するモデルです。

-   **主要フィールド**: `id`, `name`, `email` (ユニーク), `password` (ハッシュ化済み), `role` (役割、デフォルトは `customer`)。
-   **リレーション**:
    -   `Cart` (カート): ユーザー一人につき一つのカートを持つため、一対一の関係。
    -   `Order` (注文): 一人のユーザーが複数の注文を持つことができるため、一対多の関係。
    -   `OrderStatusHistory`, `InventoryHistory`: 監査目的。どのユーザーがステータス変更や在庫操作を行ったかを追跡します。

### b. `Category` & `Food` (カテゴリと商品)

商品とその分類を管理するモデルです。

-   **リレーション**: `Category` と `Food` は一対多の関係です（一つのカテゴリに複数の商品が属する）。
-   **`Food` モデルの注目ポイント**:
    -   **在庫管理フィールド**: `stock` (物理的な総在庫), `reserved` (予約済み在庫), `min_stock` (安全在庫閾値)。これにより、単純な在庫数だけでなく、「引当可能在庫数 (`stock` - `reserved`)」という概念を管理できます。
    -   **楽観的ロック**: `version` フィールド。これは、複数のリクエストが同時に同じ商品の在庫を更新しようとした際に、データの不整合を防ぐための**楽観的ロック**を実現するために使用されます。非常に高度な並行処理制御設計です。

### c. `Cart` & `CartItem` (カート)

ショッピングカート機能を実現するためのモデルです。

-   **構造**: `User` と `Cart` は一対一、`Cart` と `CartItem` は一対多の関係です。
-   `CartItem` は `Cart` と `Food` をつなぐ**中間テーブル**として機能します。
-   `@@unique([cart_id, food_id])`: `CartItem` モデルに設定されたこの複合ユニーク制約は、同じカート内に同じ商品が複数レコードとして存在することを防ぎます。数量を増やす場合は、既存のレコードの `quantity` を更新します。

### d. `Order`, `OrderItem`, `OrderStatusHistory` (注文)

注文機能の中核をなす、最も複雑で重要なモデル群です。

-   **`OrderItem` の注目ポイント**:
    -   `price: Float`: このフィールドには、ユーザーが商品を注文した**その時点での商品価格**が保存されます。これは「価格スナップショット」と呼ばれ、将来的に `Food` モデルの価格が変更されても、過去の注文の合計金額が影響を受けないようにするための極めて重要な設計です。
-   **`OrderStatusHistory` の役割**:
    -   注文のステータスが変更されるたびに、その履歴（例：`pending` -> `confirmed`）を記録する専用のテーブルです。
    -   `previous_status` (変更前の状態), `new_status` (新しい状態), `updated_by` (操作者) などの情報を含み、完全な**監査証跡（Audit Trail）**を提供します。

### e. `InventoryHistory` (在庫履歴)

-   **役割**: 在庫に対するすべての操作（追加、減算、予約、予約解除）を記録する監査テーブルです。
-   **リレーション**: どの商品(`Food`)が、誰によって(`User`)、どの注文(`Order`)に関連して操作されたかを正確に追跡できます。

## 3. 関係性のサマリー

主要なエンティティ間の関係は以下の通りです。

-   `User` (1) --- (1) `Cart`
-   `User` (1) --- (*) `Order`
-   `Category` (1) --- (*) `Food`
-   `Cart` (1) --- (*) `CartItem` (1) --- `Food` (カートと商品は多対多)
-   `Order` (1) --- (*) `OrderItem` (1) --- `Food` (注文と商品は多対多)

## 4. 結論

このデータベーススキーマは、単なるデータ格納の場所以上の役割を果たしています。楽観的ロックによる並行性制御、価格スナップショットによる歴史的データの正確性担保、そして複数の監査テーブルによる完全なトレーサビリティの確保など、本番環境での複雑な要求に応えるための高度な設計思想が随所に盛り込まれています。
