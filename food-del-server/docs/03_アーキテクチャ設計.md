# 03_ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã¨å®Ÿè£…åˆ†æ

### ğŸ›ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

ã“ã®ãƒ•ãƒ¼ãƒ‰ãƒ‡ãƒªãƒãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã‚’åŸºç›¤ã¨ã—ãŸè¨­è¨ˆã‚’æ¡ç”¨ã—ã€é–¢å¿ƒã®åˆ†é›¢ã¨ä¿å®ˆæ€§ã‚’é‡è¦–ã—ãŸæ§‹é€ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å±¤          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤             â”‚
â”‚          (Controllers/Routes)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤              â”‚
â”‚              (Services)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤                â”‚
â”‚            (Prisma ORM)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤                â”‚
â”‚            (PostgreSQL)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å±¤

#### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®éšå±¤æ§‹é€ **

```typescript
// index.ts ã§ã®æˆ¦ç•¥çš„ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é…ç½®
// 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆæœ€åˆã«é©ç”¨ï¼‰
app.use(securityHeaders);           // Helmet.js ã«ã‚ˆã‚‹åŒ…æ‹¬çš„ä¿è­·
app.use(customSecurityHeaders);     // ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
app.use(securityAuditHeaders);      // ç›£æŸ»ã¨ãƒ­ã‚°è¨˜éŒ²

// 2. CORSè¨­å®šã®å¼·åŒ–
app.use(enhancedCorsHeaders);       // Originæ¤œè¨¼ã¨ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
app.use(cors({                      // Express CORSè¨­å®š
    origin: env.CORS_ALLOWED_ORIGINS,
    credentials: env.CORS_ALLOW_CREDENTIALS
}));

// 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£è¦–ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
app.use(requestMonitoring);         // ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡ã¨ãƒ­ã‚°
app.use(requestTimeout(30000));     // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

// 4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆAPIä¿è­·ï¼‰
app.use('/api/', generalRateLimit); // ä¸€èˆ¬APIåˆ¶é™
```

#### **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡Œé †åºæˆ¦ç•¥**

ã“ã®é †åºã¯ä»¥ä¸‹ã®åŸå‰‡ã«åŸºã¥ã„ã¦ã„ã¾ã™ï¼š

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€å„ªå…ˆ**: æ‚ªæ„ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ—©æœŸã«ãƒ–ãƒ­ãƒƒã‚¯
2. **ç›£è¦–ã¨ãƒ­ã‚°**: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡
3. **ãƒªã‚½ãƒ¼ã‚¹ä¿è­·**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã§ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¿è­·
4. **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ

---

### ğŸ›£ï¸ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (Routes & Controllers)

#### **ãƒ«ãƒ¼ã‚¿ãƒ¼è¨­è¨ˆåŸå‰‡**

```typescript
// userRouter.ts - èªè¨¼é–¢é€£ãƒ«ãƒ¼ãƒˆè¨­è¨ˆ
const userRouter: Router = express.Router();

// å…¬é–‹ãƒ«ãƒ¼ãƒˆï¼ˆèªè¨¼ä¸è¦ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãï¼‰
userRouter.post("/auth/register", authRateLimit, registerUser);
userRouter.post("/auth/login", authRateLimit, loginUser);

// èªè¨¼ãƒ«ãƒ¼ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ï¼‰
userRouter.post("/auth/logout", isAuthenticated, logoutUser);
userRouter.get("/profile", isAuthenticated, getUserProfile);
userRouter.put("/profile", isAuthenticated, updateProfile);
```

#### **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®è²¬å‹™åˆ†é›¢**

```typescript
// userController.ts ã§ã®è²¬å‹™æ˜ç¢ºåŒ–
export const loginUser = async (
    req: BodyRequest<LoginRequest>,
    res: Response<ApiResponse<LoginData> | ApiResponse<null>>
): Promise<void> => {
    try {
        // 1. å…¥åŠ›å€¤æ¤œè¨¼ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®è²¬å‹™ï¼‰
        if (!email || !password) {
            res.status(400).json({
                success: false,
                message: "ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¿…è¦ã§ã™"
            });
            return;
        }

        // 2. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚µãƒ¼ãƒ“ã‚¹å±¤ã«å§”è­²
        const user = await prisma.user.findUnique({/* ... */});
        const match = await AuthService.comparePassword(password, user.password);
        const token = AuthService.createToken({/* ... */});

        // 3. é©åˆ‡ãªHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ
        res.status(200).json({
            success: true,
            message: "ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ã¾ã—ãŸ",
            data: { token, user }
        });
    } catch (error) {
        // çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    }
};
```

---

### ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ (Services)

#### **ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®è¨­è¨ˆæ€æƒ³**

```typescript
// AuthService - èªè¨¼é–¢é€£ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
export class AuthService {
    // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã®çµ±ä¸€åŒ–
    static createToken(payload: Omit<JwtPayload, 'iat' | 'exp'>): string {
        return jwt.sign(payload, env.JWT_SECRET, {
            expiresIn: '7d',
            issuer: 'food-del-api',
            audience: 'food-del-client'
        });
    }

    // è¤‡é›‘ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
    static validatePassword(password: string): ValidationResult {
        // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãè©³ç´°ãªæ¤œè¨¼
        // 2ç¨®é¡ä»¥ä¸Šã®æ–‡å­—ç¨®åˆ¥è¦æ±‚
        // å¼·åº¦ãƒ¬ãƒ™ãƒ«ã®åˆ¤å®š
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªææ¡ˆç”Ÿæˆ
    }
}
```

#### **ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®é«˜åº¦ãªæ©Ÿèƒ½ - åœ¨åº«ç®¡ç†**

```typescript
// InventoryService - è¤‡é›‘ãªåœ¨åº«ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
export class InventoryService {
    // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸåœ¨åº«æ›´æ–°
    static async updateStock(
        foodId: number,
        quantity: number,
        operation: 'add' | 'subtract',
        options: UpdateStockOptions
    ): Promise<StockUpdateResult> {
        let retries = 0;
        const maxRetries = 3;

        while (retries < maxRetries) {
            try {
                return await prisma.$transaction(async (tx) => {
                    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ä»˜ãã§æ›´æ–°
                    const updatedFood = await tx.food.updateMany({
                        where: { id: foodId, version: currentVersion },
                        data: {
                            stock: newStock,
                            version: currentVersion + 1
                        }
                    });

                    // ç«¶åˆæ¤œçŸ¥ã¨å±¥æ­´è¨˜éŒ²
                    if (updatedFood.count === 0) {
                        throw new Error('CONCURRENT_UPDATE');
                    }

                    // åœ¨åº«å¤‰æ›´å±¥æ­´ã®è¨˜éŒ²
                    await this.recordInventoryChange(tx, historyData);
                });
            } catch (error) {
                // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥
                if (error.message === 'CONCURRENT_UPDATE' && retries < maxRetries - 1) {
                    const delay = Math.random() * Math.pow(2, retries) * 50;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    retries++;
                    continue;
                }
                throw error;
            }
        }
    }
}
```

---

### ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ (Prisma ORM)

#### **Prisma ã«ã‚ˆã‚‹å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹**

```typescript
// å‹å®‰å…¨ãªã‚¯ã‚¨ãƒªå®Ÿè¡Œ
const user = await prisma.user.findUnique({
    where: { id: decoded.id },
    select: {
        id: true,
        name: true,
        email: true,
        role: true,
        phone: true,
        created_at: true,
        updated_at: true
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ„å›³çš„ã«é™¤å¤–
    }
});
```

#### **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†æˆ¦ç•¥**

```typescript
// è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
return await prisma.$transaction(async (tx) => {
    // 1. æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ã§ãƒ‡ãƒ¼ã‚¿å–å¾—
    const [food] = await tx.$queryRaw<FoodLockResult[]>`
        SELECT id, stock, reserved, status, name
        FROM foods
        WHERE id = ${foodId}
        FOR UPDATE
    `;

    // 2. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼
    if (!food.status) {
        throw new Error('å•†å“ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
    }

    // 3. ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    await tx.food.update({
        where: { id: foodId },
        data: { reserved: food.reserved + quantity }
    });

    // 4. å±¥æ­´è¨˜éŒ²
    await this.recordInventoryChange(tx, changeData);
});
```

---

### ğŸ”§ æ¨ªæ–­çš„é–¢å¿ƒäº‹ã®å‡¦ç†

#### **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥**

```typescript
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
export const errorHandler = (
    error: any,
    req: Request,
    res: Response,
    next: NextFunction
): void => {
    const statusCode = error.statusCode || 500;
    const message = error.message || 'ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼';

    res.status(statusCode).json({
        success: false,
        message,
        ...(error.code && { code: error.code })
    } as ApiResponse);
};

// ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
export class StockError extends Error {
    constructor(
        public readonly foodName: string,
        public readonly requested: number,
        public readonly available: number,
        public readonly type: 'insufficient' | 'reserved' | 'unavailable' | 'conflict'
    ) {
        super();
        this.name = 'StockError';
        this.message = this.formatMessage();
    }
}
```

#### **ãƒ­ã‚°ã¨ç›£æŸ»ã®çµ±åˆ**

```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ 
export const securityAuditHeaders = (req: Request, res: Response, next: NextFunction) => {
    // ä¸€æ„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆIDç”Ÿæˆ
    const requestId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    req.headers['x-request-id'] = requestId;
    res.setHeader('X-Request-ID', requestId);

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç›£æŸ»
    if (req.path.includes('/auth/') || req.path.includes('/admin/')) {
        res.setHeader('X-Security-Audit', 'enabled');
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å®Œäº†æ™‚ã®ãƒ­ã‚°
    res.on('finish', () => {
        if (res.statusCode >= 400) {
            console.log(`[SECURITY_AUDIT] ${req.method} ${req.path} - ${res.statusCode} - RequestID: ${requestId}`);
        }
    });
};
```

---

### ğŸ“Š å‹ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### **TypeScriptå‹å®šç¾©ã®éšå±¤åŒ–**

```typescript
// types/index.ts - å‹ã®ä¸­å¤®é›†ç´„
// å…±é€šå‹ ï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç­‰ï¼‰
export * from './common';

// èªè¨¼é–¢é€£å‹ï¼ˆAuthRequest, LoginData, TokenRefreshDataç­‰ï¼‰
export * from './auth';

// å…¬é–‹APIç”¨å‹ï¼ˆæ•æ„Ÿæƒ…å ±ã‚’é™¤å¤–ï¼‰
export type {
    PublicFood,
    PublicFoodWithCategory,
    PublicFoodSearchResult
} from './public';

// APIé–¢é€£å‹ ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç­‰ï¼‰
export type {
    FileRequest,
    ParamsRequest,
    QueryRequest,
    BodyRequest,
    FullRequest
} from './api/request';
```

#### **å‹å®‰å…¨ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†**

```typescript
// å‹å®‰å…¨ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å®šç¾©
export const getFoodById = async (
    req: ParamsRequest<IdParams>,
    res: Response<ApiResponse<PublicFoodWithCategory> | ApiResponse<null>>
): Promise<void> => {
    // IDã¯ Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šæ—¢ã«æ¤œè¨¼æ¸ˆã¿ã§å®‰å…¨
    const id = req.params.id as unknown as number;

    const food = await FoodService.getFoodById(id);

    // å…¬é–‹ç”¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ï¼ˆæ•æ„Ÿæƒ…å ±ã‚’é™¤å¤–ï¼‰
    const publicFood = toPublicFoodWithCategory(food);
};
```

---

### ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼**

```
1. HTTP Request
   â†“
2. Security Middleware
   â”œâ”€â”€ Rate Limiting Check
   â”œâ”€â”€ CORS Validation
   â”œâ”€â”€ Security Headers
   â””â”€â”€ Request Monitoring
   â†“
3. Authentication Middleware (å¿…è¦ãªå ´åˆ)
   â”œâ”€â”€ JWT Token Validation
   â”œâ”€â”€ User Information Retrieval
   â””â”€â”€ Authorization Check
   â†“
4. Route Handler
   â”œâ”€â”€ Request Parameter Validation
   â”œâ”€â”€ Business Logic Delegation
   â””â”€â”€ Response Formatting
   â†“
5. Service Layer
   â”œâ”€â”€ Complex Business Logic
   â”œâ”€â”€ Data Validation
   â””â”€â”€ External Service Integration
   â†“
6. Data Access Layer
   â”œâ”€â”€ Database Query Execution
   â”œâ”€â”€ Transaction Management
   â””â”€â”€ Data Transformation
   â†“
7. HTTP Response
   â”œâ”€â”€ Success Response
   â”œâ”€â”€ Error Handling
   â””â”€â”€ Audit Logging
```

---

### ğŸ—ï¸ å¯æ‹¡å¼µæ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§

#### **ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆåŸå‰‡**

```typescript
// æ©Ÿèƒ½åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢
src/
â”œâ”€â”€ controllers/          # ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
â”‚   â”œâ”€â”€ userController.ts
â”‚   â”œâ”€â”€ foodController.ts
â”‚   â””â”€â”€ orderController.ts
â”œâ”€â”€ services/            # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ authService.ts
â”‚   â”œâ”€â”€ inventoryService.ts
â”‚   â””â”€â”€ fileService.ts
â”œâ”€â”€ middleware/          # æ¨ªæ–­çš„é–¢å¿ƒäº‹
â”‚   â”œâ”€â”€ authMiddleware.ts
â”‚   â”œâ”€â”€ securityHeaders.ts
â”‚   â””â”€â”€ errorHandler.ts
â””â”€â”€ types/              # å‹å®šç¾©ã®ä¸­å¤®ç®¡ç†
    â”œâ”€â”€ common.ts
    â”œâ”€â”€ api/
    â””â”€â”€ utils/
```

#### **ä¾å­˜æ€§æ³¨å…¥ã®æº–å‚™**

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ç›´æ¥çš„ãªä¾å­˜æ€§æ³¨å…¥ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ãŒã€ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®é™çš„ãƒ¡ã‚½ãƒƒãƒ‰è¨­è¨ˆã«ã‚ˆã‚Šå°†æ¥çš„ãªDIã‚³ãƒ³ãƒ†ãƒŠå°å…¥ãŒå®¹æ˜“ã«ãªã£ã¦ã„ã¾ã™ã€‚

```typescript
// å°†æ¥çš„ãªDIå¯¾å¿œã®æº–å‚™
export class AuthService {
    // é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€å°†æ¥çš„ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã¨DIå°å…¥ãŒå¯èƒ½
    static createToken(payload: JwtPayload): string { /* ... */ }
    static validatePassword(password: string): ValidationResult { /* ... */ }
}
```

---

### ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹æœ€é©åŒ–**

```typescript
// N+1å•é¡Œã®å›é¿
const foods = await prisma.food.findMany({
    include: {
        category: true,        // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³äº‹å‰å–å¾—
        inventory_history: {   // å¿…è¦ãªå±¥æ­´ã®ã¿
            orderBy: { created_at: 'desc' },
            take: 5
        }
    }
});

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
// - æ¤œç´¢é »åº¦ã®é«˜ã„ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
// - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªæœ€é©åŒ–
// - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥ï¼ˆå°†æ¥çš„ãªæ‹¡å¼µï¼‰
```

#### **ä¸¦è¡Œå‡¦ç†ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**

```typescript
// æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹é«˜ä¸¦è¡Œæ€§
// - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹ç«¶åˆåˆ¶å¾¡
// - ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ã«ã‚ˆã‚‹éšœå®³å›å¾©
// - æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹è² è·åˆ†æ•£

// å°†æ¥çš„ãªã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …
// - èª­ã¿æ›¸ãåˆ†é›¢ï¼ˆRead Replicaï¼‰
// - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆRedisï¼‰
// - ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°å¯¾å¿œ
```

---

### ğŸ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡

#### **å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹**

| é …ç›® | è©•ä¾¡ | èª¬æ˜ |
|------|------|------|
| **åˆ†é›¢æ€§** | â­â­â­â­â­ | å„å±¤ã®è²¬å‹™ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ |
| **ä¿å®ˆæ€§** | â­â­â­â­â­ | ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆã«ã‚ˆã‚Šå¤‰æ›´ãŒå®¹æ˜“ |
| **æ‹¡å¼µæ€§** | â­â­â­â­â˜† | æ–°æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“ãªæ§‹é€  |
| **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£** | â­â­â­â­â˜† | å„å±¤ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | â­â­â­â­â˜† | æœ€é©åŒ–æˆ¦ç•¥ãŒé©åˆ‡ã«å®Ÿè£… |

#### **å°†æ¥çš„ãªæ”¹å–„ç‚¹**

1. **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åˆ†è§£**: æ©Ÿèƒ½åˆ¥ã‚µãƒ¼ãƒ“ã‚¹åˆ†é›¢ã®æ¤œè¨
2. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: éåŒæœŸå‡¦ç†ã®å°å…¥
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼**: Redis ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
4. **API ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
5. **ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ã®ä¿¡é ¼æ€§å‘ä¸Š

---

### ğŸ’¡ ã¾ã¨ã‚

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€å­¦ç¿’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¯éå¸¸ã«é«˜åº¦ãªè¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼š

- **ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«**: ä¼æ¥­ã‚·ã‚¹ãƒ†ãƒ ã«é©ç”¨å¯èƒ½ãªå“è³ª
- **æœ€æ–°æŠ€è¡“ã®æ´»ç”¨**: TypeScript + Bun + Prisma ã®åŠ¹æœçš„ãªçµ„ã¿åˆã‚ã›
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: å¤šå±¤é˜²å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å°†æ¥çš„ãªæˆé•·ã«å¯¾å¿œå¯èƒ½ãªè¨­è¨ˆ
- **ä¿å®ˆæ€§**: æ˜ç¢ºãªè²¬å‹™åˆ†é›¢ã¨å‹å®‰å…¨æ€§

ç‰¹ã«æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã‚’ç”¨ã„ãŸåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¯ã€å®Ÿéš›ã®ECã‚µã‚¤ãƒˆã§æ±‚ã‚ã‚‰ã‚Œã‚‹é«˜åº¦ãªä¸¦è¡Œåˆ¶å¾¡ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€éå¸¸ã«å®Ÿè·µçš„ãªå­¦ç¿’ä¾¡å€¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚