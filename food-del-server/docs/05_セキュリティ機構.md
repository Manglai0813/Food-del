# 05_ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹

## å¤šå±¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é˜²å¾¡ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¦‚è¦

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯**Defense in Depthï¼ˆå¤šå±¤é˜²å¾¡ï¼‰**æˆ¦ç•¥ã‚’æ¡ç”¨ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å„å±¤ã«é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã™ã‚‹ä¸€èˆ¬çš„ãªè„…å¨ï¼ˆOWASP Top 10ï¼‰ã«å¯¾ã—ã¦åŒ…æ‹¬çš„ãªé˜²å¾¡æ©Ÿæ§‹ã‚’æä¾›ã—ã¾ã™ã€‚

---

### ğŸ” èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

#### **JWT äºŒé‡ãƒˆãƒ¼ã‚¯ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

```typescript
// ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆçŸ­æœŸé–“æœ‰åŠ¹ï¼‰
static createToken(payload: Omit<JwtPayload, 'iat' | 'exp'>): string {
    return jwt.sign(
        payload,
        env.JWT_SECRET,
        {
            expiresIn: '7d',              // 7æ—¥é–“æœ‰åŠ¹
            issuer: 'food-del-api',       // ç™ºè¡Œè€…æ¤œè¨¼
            audience: 'food-del-client'   // å¯¾è±¡è€…æ¤œè¨¼
        }
    );
}

// ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé•·æœŸé–“æœ‰åŠ¹ï¼‰
static createRefreshToken(userId: number): string {
    return jwt.sign(
        { userId, type: 'refresh' },
        env.JWT_REFRESH_SECRET,           // åˆ¥ã®ç§˜å¯†éµ
        { expiresIn: '30d' }             // 30æ—¥é–“æœ‰åŠ¹
    );
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹å¾´:**
- **ç§˜å¯†éµåˆ†é›¢**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§ç•°ãªã‚‹ç§˜å¯†éµ
- **æœ‰åŠ¹æœŸé™ç®¡ç†**: çŸ­æœŸã‚¢ã‚¯ã‚»ã‚¹ã¨é•·æœŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®çµ„ã¿åˆã‚ã›
- **ç™ºè¡Œè€…æ¤œè¨¼**: `iss` ã¨ `aud` ã‚¯ãƒ¬ãƒ¼ãƒ ã«ã‚ˆã‚‹ç™ºè¡Œå…ƒç¢ºèª
- **å‹å®‰å…¨æ€§**: TypeScript ã«ã‚ˆã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼

#### **èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…**

```typescript
export const isAuthenticated = async (
    req: AuthRequest,
    res: Response,
    next: NextFunction
): Promise<void> => {
    try {
        // 1. Authorization ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼
        const authHeader = req.headers.authorization;
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
            return res.status(401).json({
                success: false,
                message: "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™"
            });
        }

        // 2. JWT ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
        const token = authHeader.split(' ')[1];
        const decoded = jwt.verify(token, env.JWT_SECRET);

        // 3. å‹å®‰å…¨ãªæ¤œè¨¼
        if (!isJwtPayload(decoded)) {
            return res.status(401).json({
                success: false,
                message: "ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ã™"
            });
        }

        // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ç¢ºèª
        const user = await prisma.user.findUnique({
            where: { id: decoded.id },
            select: {
                id: true, name: true, email: true, role: true,
                phone: true, created_at: true, updated_at: true
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ„å›³çš„ã«é™¤å¤–
            }
        });

        if (!user) {
            return res.status(404).json({
                success: false,
                message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            });
        }

        req.user = user;
        next();

    } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®è©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
        if (error instanceof jwt.TokenExpiredError) {
            return res.status(401).json({
                success: false,
                message: "ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™",
                code: "TOKEN_EXPIRED"
            });
        }
        // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†...
    }
};
```

#### **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ (RBAC)**

```typescript
// ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
export const isAdmin = (req: AuthRequest, res: Response, next: NextFunction): void => {
    if (!req.user || req.user.role !== 'admin') {
        return res.status(403).json({
            success: false,
            message: "ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™",
            code: "INSUFFICIENT_PERMISSIONS"
        });
    }
    next();
};

// éšå±¤çš„æ¨©é™ãƒã‚§ãƒƒã‚¯
export const isStaff = (req: AuthRequest, res: Response, next: NextFunction): void => {
    const allowedRoles = ['admin', 'staff'];
    if (!req.user || !allowedRoles.includes(req.user.role)) {
        return res.status(403).json({
            success: false,
            message: "ã‚¹ã‚¿ãƒƒãƒ•æ¨©é™ãŒå¿…è¦ã§ã™"
        });
    }
    next();
};
```

---

### ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### **é«˜åº¦ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ **

```typescript
static validatePassword(password: string): {
    isValid: boolean;
    errors: string[];
    strength: 'weak' | 'medium' | 'strong';
    suggestions: string[];
} {
    const errors: string[] = [];
    const suggestions: string[] = [];
    let characterTypes = 0;

    // åŸºæœ¬çš„ãªé•·ã•ãƒã‚§ãƒƒã‚¯
    if (password.length < 8) {
        errors.push('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æœ€ä½8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    }

    // æ–‡å­—ç¨®åˆ¥ã®ç¢ºèª
    const hasUppercase = /[A-Z]/.test(password);
    const hasLowercase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecialChars = /[!@#$%^&*(),.?":{}|<>]/.test(password);

    if (hasUppercase) characterTypes++;
    if (hasLowercase) characterTypes++;
    if (hasNumbers) characterTypes++;
    if (hasSpecialChars) characterTypes++;

    // UXã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒãƒ©ãƒ³ã‚¹ - æœ€ä½2ç¨®é¡ã®æ–‡å­—ç¨®åˆ¥
    if (characterTypes < 2) {
        errors.push('å°‘ãªãã¨ã‚‚2ç¨®é¡ã®æ–‡å­—ç¨®åˆ¥ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');

        // å…·ä½“çš„ãªææ¡ˆ
        if (!hasNumbers && !hasSpecialChars) {
            suggestions.push('æ•°å­—ã¾ãŸã¯ç‰¹æ®Šæ–‡å­—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        }
    }

    // å¼·åº¦åˆ¤å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
    let strength: 'weak' | 'medium' | 'strong';
    if (password.length >= 12 && characterTypes >= 3) {
        strength = 'strong';
    } else if (password.length >= 8 && characterTypes >= 2) {
        strength = 'medium';
    } else {
        strength = 'weak';
    }

    return { isValid: errors.length === 0, errors, strength, suggestions };
}
```

#### **bcrypt ã«ã‚ˆã‚‹å®‰å…¨ãªãƒãƒƒã‚·ãƒ¥åŒ–**

```typescript
// ã‚½ãƒ«ãƒˆãƒ©ã‚¦ãƒ³ãƒ‰10ã«ã‚ˆã‚‹å …ç‰¢ãªãƒãƒƒã‚·ãƒ¥åŒ–
static async hashPassword(password: string): Promise<string> {
    return bcrypt.hash(password, 10);
}

// ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒè€æ€§ã®ã‚ã‚‹æ¯”è¼ƒ
static async comparePassword(password: string, hash: string): Promise<boolean> {
    return bcrypt.compare(password, hash);
}
```

---

### ğŸš« ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚·ã‚¹ãƒ†ãƒ 

#### **å¤šå±¤ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

```typescript
// 1. ä¸€èˆ¬APIç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™ - 15åˆ†é–“ã§100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
export const generalRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 100,
    message: {
        success: false,
        message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚15åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚',
        code: 'RATE_LIMIT_EXCEEDED',
        retryAfter: 900
    },
    standardHeaders: true,  // Rate limitæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹
    legacyHeaders: false
});

// 2. èªè¨¼APIç”¨å³æ ¼åˆ¶é™ - ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–
export const authRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 5,  // ã‚ˆã‚Šå³ã—ã„åˆ¶é™
    skipSuccessfulRequests: true,  // æˆåŠŸã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
    handler: (req: Request, res: Response) => {
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
        console.warn(`[SECURITY] Auth rate limit exceeded for IP: ${req.ip}`);
        res.status(429).json({
            success: false,
            message: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡ŒãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™',
            code: 'AUTH_RATE_LIMIT_EXCEEDED',
            retryAfter: 900
        });
    }
});

// 3. ç®¡ç†è€…APIç”¨è¶…å³æ ¼åˆ¶é™ - 5åˆ†é–“ã§20ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
export const adminRateLimit = rateLimit({
    windowMs: 5 * 60 * 1000,
    max: 20,
    handler: (req: Request, res: Response) => {
        const userId = (req as any).user?.id;
        console.warn(`[SECURITY] Admin rate limit reached for user: ${userId}, IP: ${req.ip}`);
        // ç®¡ç†è€…æ“ä½œã®è©³ç´°ãƒ­ã‚°
    }
});
```

#### **é©å¿œå‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™**

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿¡é ¼åº¦ã«åŸºã¥ãå‹•çš„åˆ¶é™
export const adaptiveRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: (req: Request) => {
        const user = (req as any).user;

        if (!user) return 50; // æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åˆ¶é™

        // ãƒ­ãƒ¼ãƒ«åˆ¥ã®åˆ¶é™èª¿æ•´
        switch (user.role) {
            case 'admin': return 200;   // ç®¡ç†è€…ã¯ç·©ã„åˆ¶é™
            case 'staff': return 150;   // ã‚¹ã‚¿ãƒƒãƒ•ã¯ä¸­ç¨‹åº¦
            default: return 100;        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
        }
    }
});
```

---

### ğŸ›¡ï¸ HTTP ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

#### **Helmet.js ã«ã‚ˆã‚‹åŒ…æ‹¬çš„ä¿è­·**

```typescript
export const securityHeaders = helmet({
    // Content Security Policy - XSSæ”»æ’ƒã®åŒ…æ‹¬çš„é˜²æ­¢
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: [
                "'self'",
                "'unsafe-inline'",  // CSSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å¯¾å¿œ
                "https://fonts.googleapis.com"
            ],
            scriptSrc: [
                "'self'",
                // é–‹ç™ºç’°å¢ƒã§ã¯ eval() ã‚’è¨±å¯
                ...(process.env.NODE_ENV === 'development' ? ["'unsafe-eval'"] : [])
            ],
            imgSrc: ["'self'", "data:", "https:", "blob:"],
            objectSrc: ["'none'"],      // Flashç­‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç¦æ­¢
            frameSrc: ["'none'"],       // iframeç¦æ­¢
            baseUri: ["'self'"],        // base ã‚¿ã‚°åˆ¶é™
            formAction: ["'self'"]      // formé€ä¿¡å…ˆåˆ¶é™
        }
    },

    // HTTP Strict Transport Security - HTTPSå¼·åˆ¶
    hsts: process.env.NODE_ENV === 'production' ? {
        maxAge: 31536000,       // 1å¹´é–“
        includeSubDomains: true,
        preload: true
    } : false,

    // Referrer Policy - ãƒªãƒ•ã‚¡ãƒ©ãƒ¼æƒ…å ±ã®åˆ¶å¾¡
    referrerPolicy: { policy: 'strict-origin-when-cross-origin' },

    // Permission Policy - ãƒ–ãƒ©ã‚¦ã‚¶æ©Ÿèƒ½ã®åˆ¶é™
    permissionsPolicy: {
        features: {
            camera: ["'none'"],         // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
            microphone: ["'none'"],     // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
            geolocation: ["'self'"],    // ä½ç½®æƒ…å ±ã¯è‡ªåˆ†ã®ã‚ªãƒªã‚¸ãƒ³ã®ã¿
            payment: ["'none'"],        // æ”¯æ‰•ã„APIç¦æ­¢
            usb: ["'none'"]            // USB APIç¦æ­¢
        }
    }
});
```

#### **ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**

```typescript
export const customSecurityHeaders = (req: Request, res: Response, next: NextFunction) => {
    // ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã®éš è”½
    res.removeHeader('X-Powered-By');
    res.removeHeader('Server');

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 
    res.setHeader('X-API-Version', '1.0');
    res.setHeader('X-Security-Policy', '2024.1');
    res.setHeader('X-Permitted-Cross-Domain-Policies', 'none');
    res.setHeader('X-Download-Options', 'noopen');

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡
    if (req.path.includes('/auth/') || req.path.includes('/admin/')) {
        res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
        res.setHeader('Pragma', 'no-cache');
        res.setHeader('Expires', '0');
    }

    next();
};
```

---

### ğŸ” CORS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

#### **Origin æ¤œè¨¼ã¨ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°**

```typescript
export const enhancedCorsHeaders = (req: Request, res: Response, next: NextFunction) => {
    const origin = req.get('Origin');
    const allowedOrigins = process.env.CORS_ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'];

    // å³æ ¼ãª Origin æ¤œè¨¼
    if (origin && !allowedOrigins.includes(origin)) {
        console.warn(`[SECURITY] Blocked request from unauthorized origin: ${origin}`);

        // ä¸æ­£ãªOriginã‹ã‚‰ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
        if (req.path.startsWith('/api/')) {
            return res.status(403).json({
                success: false,
                message: 'ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',
                code: 'CORS_ORIGIN_DENIED'
            });
        }
    }

    // Preflight ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
    if (req.method === 'OPTIONS') {
        res.setHeader('Access-Control-Max-Age', '300');  // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        res.setHeader('Vary', 'Origin, Access-Control-Request-Method, Access-Control-Request-Headers');
    }

    next();
};
```

---

### ğŸ“Š ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£è¦–ãƒ»ç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ 

#### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°**

```typescript
export const securityAuditHeaders = (req: Request, res: Response, next: NextFunction) => {
    // ä¸€æ„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆIDç”Ÿæˆ
    const requestId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    req.headers['x-request-id'] = requestId;
    res.setHeader('X-Request-ID', requestId);

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç›£æŸ»æœ‰åŠ¹åŒ–
    if (req.path.includes('/auth/') || req.path.includes('/admin/')) {
        res.setHeader('X-Security-Audit', 'enabled');
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å®Œäº†æ™‚ã®è©³ç´°ãƒ­ã‚°
    res.on('finish', () => {
        if (res.statusCode >= 400) {
            console.log(`[SECURITY_AUDIT] ${req.method} ${req.path} - ${res.statusCode} - RequestID: ${requestId} - IP: ${req.ip}`);
        }
    });

    next();
};
```

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶å¾¡ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**

```typescript
// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
export const requestTimeout = (timeout: number = 30000) => {
    return (req: Request, res: Response, next: NextFunction) => {
        const timer = setTimeout(() => {
            if (!res.headersSent) {
                res.status(408).json({
                    success: false,
                    message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ',
                    code: 'REQUEST_TIMEOUT'
                });
            }
        }, timeout);

        res.on('finish', () => clearTimeout(timer));
        next();
    };
};

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºåˆ¶é™
export const requestSizeLimits = {
    json: { limit: '10mb' },
    urlencoded: { limit: '10mb', extended: true },
    raw: { limit: '10mb' },
    text: { limit: '10mb' }
};
```

---

### ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### **æƒ…å ±æ¼æ´©é˜²æ­¢ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

```typescript
export const errorHandler = (
    error: any,
    req: Request,
    res: Response,
    next: NextFunction
): void => {
    // æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’éš è”½
    const isProduction = process.env.NODE_ENV === 'production';
    const statusCode = error.statusCode || 500;

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é…æ…®ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let message = error.message || 'ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼';

    if (isProduction && statusCode === 500) {
        message = 'ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';  // è©³ç´°ã‚’éš è”½
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
    if (statusCode >= 400) {
        console.error(`[SECURITY_ERROR] ${statusCode}: ${error.message} - Path: ${req.path} - IP: ${req.ip}`);
    }

    res.status(statusCode).json({
        success: false,
        message,
        ...(error.code && { code: error.code }),
        // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯é–‹ç™ºç’°å¢ƒã®ã¿
        ...(process.env.NODE_ENV === 'development' && { stack: error.stack })
    } as ApiResponse);
};
```

---

### ğŸ” ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†

#### **ã‚»ã‚­ãƒ¥ã‚¢ãªç’°å¢ƒå¤‰æ•°æ¤œè¨¼**

```typescript
function validateEnv(): EnvConfig {
    const config = {
        JWT_SECRET: process.env.JWT_SECRET,
        JWT_REFRESH_SECRET: process.env.JWT_REFRESH_SECRET,
        DATABASE_URL: process.env.DATABASE_URL,
        // ...ãã®ä»–ã®è¨­å®š
    };

    // å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
    const requiredVars = ['JWT_SECRET', 'JWT_REFRESH_SECRET', 'DATABASE_URL'];
    const missing = requiredVars.filter(key => !config[key]);

    if (missing.length > 0) {
        console.error('Missing required environment variables:', missing);
        process.exit(1);  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªè¨­å®šä¸å‚™ã§åœæ­¢
    }

    // JWT_SECRETå¼·åº¦ãƒã‚§ãƒƒã‚¯
    if (config.JWT_SECRET && config.JWT_SECRET.length < 32) {
        console.warn('Warning: JWT_SECRET should be at least 32 characters for security');
    }

    return config as EnvConfig;
}
```

---

### ğŸ› ï¸ è„†å¼±æ€§å¯¾ç­–ã¾ã¨ã‚

#### **OWASP Top 10 å¯¾ç­–çŠ¶æ³**

| è„†å¼±æ€§ | å¯¾ç­–çŠ¶æ³ | å®Ÿè£…è©³ç´° |
|--------|----------|----------|
| **A01: Broken Access Control** | âœ… å®Œå…¨å¯¾å¿œ | JWTèªè¨¼ + RBAC + ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ¤œè¨¼ |
| **A02: Cryptographic Failures** | âœ… å®Œå…¨å¯¾å¿œ | bcrypt + å¼·åŠ›ãªJWTç§˜å¯†éµ + HTTPSå¼·åˆ¶ |
| **A03: Injection** | âœ… å®Œå…¨å¯¾å¿œ | Prisma ORM + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª |
| **A04: Insecure Design** | âœ… å®Œå…¨å¯¾å¿œ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆ |
| **A05: Security Misconfiguration** | âœ… å®Œå…¨å¯¾å¿œ | Helmet.js + ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ |
| **A06: Vulnerable Components** | âœ… ç›£è¦–ä¸­ | ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–° |
| **A07: Identity Authentication** | âœ… å®Œå…¨å¯¾å¿œ | å¼·åŒ–èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  |
| **A08: Software Data Integrity** | âœ… å®Œå…¨å¯¾å¿œ | ç½²åæ¤œè¨¼ + æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ |
| **A09: Logging Monitoring** | âœ… å®Œå…¨å¯¾å¿œ | åŒ…æ‹¬çš„ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  |
| **A10: Server-Side Request** | âœ… äºˆé˜²æ¸ˆã¿ | å¤–éƒ¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ |

---

### ğŸ“ˆ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹

#### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æˆç†Ÿåº¦è©•ä¾¡**

```
èªè¨¼ãƒ»èªå¯      â­â­â­â­â­ (5/5) - JWT + RBAC + å¤šè¦ç´ æ¤œè¨¼
ãƒ‡ãƒ¼ã‚¿ä¿è­·      â­â­â­â­â­ (5/5) - æš—å·åŒ– + ãƒãƒƒã‚·ãƒ¥åŒ–
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯    â­â­â­â­â­ (5/5) - HTTPS + CORS + ãƒ˜ãƒƒãƒ€ãƒ¼
å…¥åŠ›æ¤œè¨¼        â­â­â­â­â­ (5/5) - Zod + Prisma + ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
ãƒ­ã‚°ãƒ»ç›£è¦–      â­â­â­â­â­ (5/5) - åŒ…æ‹¬çš„ç›£æŸ»ãƒ­ã‚°
ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ    â­â­â­â­â˜† (4/5) - ã‚¨ãƒ©ãƒ¼å‡¦ç† + ã‚¢ãƒ©ãƒ¼ãƒˆ
```

#### **ç¶™ç¶šçš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„**

```typescript
// å°†æ¥çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨ˆç”»
const securityRoadmap = {
    'çŸ­æœŸç›®æ¨™': [
        'ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿæ–½',
        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è‡ªå‹•åŒ–',
        'CSPé•åãƒ¬ãƒãƒ¼ãƒˆåˆ†æ'
    ],
    'ä¸­æœŸç›®æ¨™': [
        'WAFçµ±åˆ',
        'ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ',
        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰'
    ],
    'é•·æœŸç›®æ¨™': [
        'ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£',
        'è‡ªå‹•è„…å¨å¯¾å¿œ',
        'AI ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ'
    ]
};
```

---

### ğŸ’¡ ã¾ã¨ã‚

ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã¯ã€ç¾ä»£ã®Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¦æ±‚ã•ã‚Œã‚‹åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼š

- **å¤šå±¤é˜²å¾¡**: å„å±¤ã§ã®é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶å¾¡
- **ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ**: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼
- **æ·±å±¤é˜²è­·**: å˜ä¸€éšœå®³ç‚¹ã®æ’é™¤
- **ç¶™ç¶šç›£è¦–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- **ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ**: è¿…é€Ÿãªè„…å¨æ¤œå‡ºã¨å¯¾å¿œ

ç‰¹ã« JWT äºŒé‡ãƒˆãƒ¼ã‚¯ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã¨æ¥½è¦³çš„ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã¯ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã—ã¦ãŠã‚Šã€å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã‚‚ä½¿ç”¨å¯èƒ½ãªå …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã¨ãªã£ã¦ã„ã¾ã™ã€‚