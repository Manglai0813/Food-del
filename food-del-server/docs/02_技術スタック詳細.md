# 02_æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆã¨è©³ç´°åˆ†æ

### ğŸš€ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒ

#### **Bun 1.0+**
```json
"scripts": {
  "dev": "bun --watch index.ts",
  "start": "bun index.ts"
}
```

**é¸æŠç†ç”±:**
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Node.js ã‚ˆã‚Šé«˜é€Ÿãªå®Ÿè¡Œé€Ÿåº¦
- **TypeScript ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆ**: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ä¸è¦
- **äº’æ›æ€§**: Node.js ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®å®Œå…¨äº’æ›
- **é–‹ç™ºä½“é¨“**: å†…è”µãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

**å…·ä½“çš„ãƒ¡ãƒªãƒƒãƒˆ:**
- èµ·å‹•æ™‚é–“ã®å¤§å¹…çŸ­ç¸®
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–
- TypeScript ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›´æ¥å®Ÿè¡Œ

---

### ğŸ—ï¸ Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

#### **Express.js 4.21.2**
```typescript
const app: Express = express();

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨ï¼ˆé †åºé‡è¦ï¼‰
app.use(securityHeaders);
app.use(customSecurityHeaders);
app.use(enhancedCorsHeaders);
```

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç‰¹å¾´:**
- **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æŒ‡å‘**: æ¨ªæ–­çš„é–¢å¿ƒäº‹ã®åˆ†é›¢
- **Express å‹æ‹¡å¼µ**: TypeScript ã‚«ã‚¹ã‚¿ãƒ å‹å®šç¾©
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆ**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®æˆ¦ç•¥çš„é…ç½®

#### **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆ:**
```typescript
// 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆæœ€åˆã«é©ç”¨ï¼‰
app.use(securityHeaders);
app.use(customSecurityHeaders);
app.use(securityAuditHeaders);

// 2. CORSè¨­å®šã®å¼·åŒ–
app.use(enhancedCorsHeaders);
app.use(cors({ /* è¨­å®š */ }));

// 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£è¦–ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
app.use(requestMonitoring);
app.use(requestTimeout(30000));

// 4. ä¸€èˆ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™
app.use('/api/', generalRateLimit);

// 5. JSON/URL-encodedãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™ä»˜ãï¼‰
app.use(express.json(requestSizeLimits.json));
```

---

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“

#### **PostgreSQL**
```env
DATABASE_URL=postgresql://username:password@localhost:5432/database
```

**é¸æŠç†ç”±:**
- **ACIDæº–æ‹ **: ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§ã®ä¿è¨¼
- **é«˜æ€§èƒ½**: è¤‡é›‘ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- **æ‹¡å¼µæ€§**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
- **JSON ã‚µãƒãƒ¼ãƒˆ**: æ§‹é€ åŒ–ãƒ»éæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®æ··åˆå¯¾å¿œ

#### **Prisma ORM 6.6.0**
```typescript
// Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

**Prisma ã®æŠ€è¡“çš„å„ªä½æ€§:**
- **å‹å®‰å…¨æ€§**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹ãƒã‚§ãƒƒã‚¯
- **ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™º**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã•ã‚ŒãŸ DB ã‚¹ã‚­ãƒ¼ãƒ
- **ã‚¯ã‚¨ãƒªæœ€é©åŒ–**: è‡ªå‹•çš„ãª N+1 å•é¡Œå¯¾ç­–

#### **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥:**
```sql
-- 20250925144345_add_order_status_history
-- æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
CREATE TABLE "order_status_history" (
    "id" SERIAL NOT NULL,
    "order_id" INTEGER NOT NULL,
    "previous_status" TEXT NOT NULL,
    "new_status" TEXT NOT NULL,
    "updated_by" INTEGER NOT NULL,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "order_status_history_pkey" PRIMARY KEY ("id")
);
```

---

### ğŸ” èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### **JWT (jsonwebtoken 9.0.2)**
```typescript
// ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
static createToken(payload: Omit<JwtPayload, 'iat' | 'exp'>): string {
    return jwt.sign(
        payload,
        env.JWT_SECRET,
        {
            expiresIn: '7d',
            issuer: 'food-del-api',
            audience: 'food-del-client'
        }
    );
}

// ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
static createRefreshToken(userId: number): string {
    return jwt.sign(
        { userId, type: 'refresh' },
        env.JWT_REFRESH_SECRET,
        { expiresIn: '30d' }
    );
}
```

**JWT å®Ÿè£…ã®ç‰¹å¾´:**
- **ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³ã‚·ã‚¹ãƒ†ãƒ **: ã‚¢ã‚¯ã‚»ã‚¹ + ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
- **å‹å®‰å…¨ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**: TypeScript å‹å®šç¾©
- **ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®š**: é©åˆ‡ãªæœ‰åŠ¹æœŸé™ã¨æš—å·åŒ–

#### **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (bcryptjs 3.0.2)**
```typescript
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
static async hashPassword(password: string): Promise<string> {
    return bcrypt.hash(password, 10); // ã‚½ãƒ«ãƒˆãƒ©ã‚¦ãƒ³ãƒ‰: 10
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦æ¤œè¨¼
static validatePassword(password: string): {
    isValid: boolean;
    errors: string[];
    strength: 'weak' | 'medium' | 'strong';
    suggestions: string[];
} {
    // è¤‡é›‘ãªæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
}
```

---

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

#### **Helmet.js 8.1.0 - åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**
```typescript
export const securityHeaders = helmet({
    // Content Security Policy: XSSæ”»æ’ƒã®åŒ…æ‹¬çš„é˜²æ­¢
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
            scriptSrc: ["'self'"],
            imgSrc: ["'self'", "data:", "https:", "blob:"],
            objectSrc: ["'none'"],
            frameSrc: ["'none'"]
        }
    },
    // HTTP Strict Transport Security: HTTPSå¼·åˆ¶
    hsts: process.env.NODE_ENV === 'production' ? {
        maxAge: 31536000,
        includeSubDomains: true,
        preload: true
    } : false
});
```

#### **Express Rate Limit 8.1.0 - å¤šå±¤ãƒ¬ãƒ¼ãƒˆåˆ¶é™**
```typescript
// ä¸€èˆ¬çš„ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™
export const generalRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000, // 15åˆ†é–“
    max: 100, // æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
    message: {
        success: false,
        message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚15åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚',
        code: 'RATE_LIMIT_EXCEEDED'
    }
});

// èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨å³æ ¼åˆ¶é™
export const authRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 5, // ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–
    skipSuccessfulRequests: true
});
```

---

### ğŸ“ TypeScript æ§‹æˆ

#### **TypeScript 5.8.2 è¨­å®š**
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@/types/*": ["src/types/*"],
      "@/types": ["src/types/index"]
    }
  }
}
```

**TypeScript ã®æ´»ç”¨:**
- **å³æ ¼ãƒ¢ãƒ¼ãƒ‰**: æœ€é«˜ãƒ¬ãƒ™ãƒ«ã®å‹ãƒã‚§ãƒƒã‚¯
- **ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹**: ç›¸å¯¾ãƒ‘ã‚¹ã®è¤‡é›‘æ€§è§£æ¶ˆ
- **å‹æ¨è«–æœ€é©åŒ–**: `noUncheckedIndexedAccess` ã§ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼é˜²æ­¢

#### **ã‚«ã‚¹ã‚¿ãƒ å‹å®šç¾©ä¾‹:**
```typescript
// APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®çµ±ä¸€
export interface ApiResponse<T = any> {
    success: boolean;
    message: string;
    data?: T;
    errors?: string[];
}

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹
export interface PaginatedResponse<T> extends ApiResponse<T[]> {
    pagination: {
        page: number;
        limit: number;
        total: number;
        totalPages: number;
        hasNext: boolean;
        hasPrev: boolean;
    };
}
```

---

### ğŸ”§ é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

#### **ç’°å¢ƒå¤‰æ•°ç®¡ç† (dotenv 16.5.0)**
```typescript
// ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ã¨å‹å®‰å…¨ãªè¨­å®š
interface EnvConfig {
    JWT_SECRET: string;
    JWT_REFRESH_SECRET: string;
    DATABASE_URL: string;
    PORT: number;
    NODE_ENV: string;
    CORS_ALLOWED_ORIGINS: string[];
    CORS_ALLOW_CREDENTIALS: boolean;
}

// èµ·å‹•æ™‚æ¤œè¨¼
function validateEnv(): EnvConfig {
    const requiredVars = ['JWT_SECRET', 'JWT_REFRESH_SECRET', 'DATABASE_URL'];
    const missing = requiredVars.filter(key => !process.env[key]);

    if (missing.length > 0) {
        console.error('Missing required environment variables:', missing);
        process.exit(1);
    }
    // ...
}
```

#### **ä¾å­˜é–¢ä¿‚ç®¡ç†**
```json
{
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/express": "^5.0.1",
    "@types/jsonwebtoken": "^9.0.9",
    "@types/multer": "^1.4.12",
    "prisma": "^6.6.0",
    "typescript": "^5.8.2"
  },
  "dependencies": {
    "@prisma/client": "^6.6.0",
    "express": "^4.21.2",
    "express-rate-limit": "^8.1.0",
    "helmet": "^8.1.0",
    "jsonwebtoken": "^9.0.2",
    "validator": "^13.12.0",
    "zod": "^4.1.9"
  }
}
```

---

### ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æŠ€è¡“

#### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–**
```sql
-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX "order_status_history_order_id_idx" ON "order_status_history"("order_id");
CREATE INDEX "order_status_history_updated_at_idx" ON "order_status_history"("updated_at");
CREATE INDEX "inventory_history_food_id_idx" ON "inventory_history"("food_id");
CREATE INDEX "inventory_history_created_at_idx" ON "inventory_history"("created_at");
CREATE INDEX "inventory_history_change_type_idx" ON "inventory_history"("change_type");
```

#### **ãƒ¡ãƒ¢ãƒªãƒ»CPU æœ€é©åŒ–**
```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºåˆ¶é™
const requestSizeLimits = {
    json: { limit: '10mb' },
    urlencoded: { limit: '10mb', extended: true },
    raw: { limit: '10mb' },
    text: { limit: '10mb' }
};

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
app.use(requestTimeout(30000)); // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

---

### ğŸ” ç›£è¦–ãƒ»ãƒ­ã‚°

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£è¦–**
```typescript
export const requestMonitoring = (req: Request, res: Response, next: NextFunction) => {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDç”Ÿæˆï¼ˆãƒ­ã‚°è¿½è·¡ç”¨ï¼‰
    const requestId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    req.headers['x-request-id'] = requestId;
    res.setHeader('X-Request-ID', requestId);

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å®Œäº†æ™‚ã®ãƒ­ã‚°è¨˜éŒ²
    res.on('finish', () => {
        if (res.statusCode >= 400) {
            console.log(`[SECURITY_AUDIT] ${req.method} ${req.path} - ${res.statusCode} - RequestID: ${requestId}`);
        }
    });
};
```

---

### ğŸ“ˆ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®è©•ä¾¡

#### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢**
- **Bun Runtime**: â­â­â­â­â­ (5/5) - æœ€é«˜é€Ÿåº¦
- **TypeScript**: â­â­â­â­â­ (5/5) - å®Œå…¨ãªå‹å®‰å…¨æ€§
- **Prisma ORM**: â­â­â­â­â­ (5/5) - é–‹ç™ºåŠ¹ç‡ã¨å‹å®‰å…¨æ€§
- **Express.js**: â­â­â­â­â˜† (4/5) - æˆç†Ÿã—ãŸã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 

#### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢**
- **JWTèªè¨¼**: â­â­â­â­â­ (5/5) - æ¥­ç•Œæ¨™æº–å®Ÿè£…
- **Helmet.js**: â­â­â­â­â­ (5/5) - åŒ…æ‹¬çš„ä¿è­·
- **Rate Limiting**: â­â­â­â­â­ (5/5) - å¤šå±¤é˜²å¾¡
- **å…¥åŠ›æ¤œè¨¼**: â­â­â­â­â˜† (4/5) - Zod ã«ã‚ˆã‚‹å³æ ¼æ¤œè¨¼

#### **é–‹ç™ºä½“é¨“ã‚¹ã‚³ã‚¢**
- **TypeScript**: â­â­â­â­â­ (5/5) - IDE ã‚µãƒãƒ¼ãƒˆã¨ã‚¨ãƒ©ãƒ¼é˜²æ­¢
- **Prisma**: â­â­â­â­â­ (5/5) - ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™º
- **Hot Reload**: â­â­â­â­â­ (5/5) - å³åº§ã®é–‹ç™ºãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: â­â­â­â­â­ (5/5) - çµ±åˆã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

---

### ğŸ¯ ã¾ã¨ã‚

ã“ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆã¯ã€ç¾ä»£çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å®Œå…¨ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ï¼š

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Bun + TypeScript ã®çµ„ã¿åˆã‚ã›
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å¤šå±¤é˜²å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
3. **å‹å®‰å…¨æ€§**: ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã® TypeScript æ´»ç”¨
4. **é–‹ç™ºåŠ¹ç‡**: æœ€æ–°ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®çµ±åˆ
5. **ä¿å®ˆæ€§**: æ˜ç¢ºãªåˆ†é›¢ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã«ã‚‚å¯¾å¿œã§ãã‚‹å …ç‰¢ãªæŠ€è¡“åŸºç›¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚