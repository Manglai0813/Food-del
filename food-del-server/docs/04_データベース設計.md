# 04_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ã‚¹ã‚­ãƒ¼ãƒžåˆ†æž

### ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¦‚è¦

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **: PostgreSQL
**ORM**: Prisma 6.6.0
**è¨­è¨ˆæ€æƒ³**: é–¢ä¿‚æ­£è¦åŒ–ã¨ç›£æŸ»è¨¼è·¡ã®ä¸¡ç«‹
**ç‰¹å¾´**: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®æ•´åˆæ€§åˆ¶ç´„ã¨å±¥æ­´ç®¡ç†

---

### ðŸ“Š ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é–¢ä¿‚å›³ (ERD)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1:N    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    N:1    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”‚    Order    â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”‚  Category   â”‚
â”‚             â”‚           â”‚             â”‚           â”‚             â”‚
â”‚ id (PK)     â”‚           â”‚ id (PK)     â”‚           â”‚ id (PK)     â”‚
â”‚ name        â”‚           â”‚ user_id(FK) â”‚    1:N    â”‚ name        â”‚
â”‚ email       â”‚           â”‚ status      â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡ â”‚ description â”‚
â”‚ password    â”‚           â”‚ total       â”‚           â”‚ status      â”‚
â”‚ role        â”‚           â”‚ address     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ phone       â”‚           â”‚ phone       â”‚
â”‚ created_at  â”‚           â”‚ notes       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ updated_at  â”‚           â”‚ order_date  â”‚    N:1    â”‚    Food     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ updated_at  â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”‚             â”‚
       â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ id (PK)     â”‚
       â”‚ 1:1                     â”‚                  â”‚ name        â”‚
       â–¼                         â”‚ 1:N              â”‚ description â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â–¼                  â”‚ price       â”‚
â”‚    Cart     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ category_id â”‚
â”‚             â”‚    1:N    â”‚ OrderItem   â”‚           â”‚ image_path  â”‚
â”‚ id (PK)     â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”‚             â”‚           â”‚ status      â”‚
â”‚ user_id(FK) â”‚           â”‚ id (PK)     â”‚           â”‚ stock       â”‚
â”‚ created_at  â”‚           â”‚ order_id(FK)â”‚           â”‚ reserved    â”‚
â”‚ updated_at  â”‚           â”‚ food_id(FK) â”‚           â”‚ min_stock   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ quantity    â”‚           â”‚ version     â”‚
       â”‚                  â”‚ price       â”‚           â”‚ created_at  â”‚
       â”‚ 1:N              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ updated_at  â”‚
       â–¼                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  CartItem   â”‚                                            â”‚ 1:N
â”‚             â”‚                                            â–¼
â”‚ id (PK)     â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ cart_id(FK) â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚InventoryHis â”‚
â”‚ food_id(FK) â”‚    N:1   â”‚   Status    â”‚    â”‚             â”‚
â”‚ quantity    â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”‚   History   â”‚    â”‚ id (PK)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚             â”‚    â”‚ food_id(FK) â”‚
                         â”‚ id (PK)     â”‚    â”‚ change_type â”‚
                         â”‚ order_id(FK)â”‚    â”‚ quantity    â”‚
                         â”‚ prev_status â”‚    â”‚ prev_stock  â”‚
                         â”‚ new_status  â”‚    â”‚ new_stock   â”‚
                         â”‚ updated_by  â”‚    â”‚ order_id(FK)â”‚
                         â”‚ updated_at  â”‚    â”‚ created_by  â”‚
                         â”‚ note        â”‚    â”‚ created_at  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ note        â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ðŸ—ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆè©³ç´°

#### **Users ãƒ†ãƒ¼ãƒ–ãƒ« - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**

```sql
CREATE TABLE "users" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "role" TEXT NOT NULL DEFAULT 'customer',
    "phone" TEXT,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "users_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
```

**è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ:**
- **ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„**: email ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢
- **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: customer/staff/admin ã®éšŽå±¤ç®¡ç†
- **ç›£æŸ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**: created_at, updated_at ã«ã‚ˆã‚‹å¤‰æ›´è¿½è·¡
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: password ã¯ bcrypt ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦æ ¼ç´

#### **Categories ãƒ†ãƒ¼ãƒ–ãƒ« - ã‚«ãƒ†ã‚´ãƒªç®¡ç†**

```sql
CREATE TABLE "categories" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "status" BOOLEAN NOT NULL DEFAULT true,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "categories_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX "categories_name_key" ON "categories"("name");
```

**è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ:**
- **è«–ç†å‰Šé™¤**: status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ˆã‚‹æœ‰åŠ¹/ç„¡åŠ¹ç®¡ç†
- **ã‚«ãƒ†ã‚´ãƒªåã®ä¸€æ„æ€§**: é‡è¤‡ã‚«ãƒ†ã‚´ãƒªåã‚’é˜²æ­¢

#### **Foods ãƒ†ãƒ¼ãƒ–ãƒ« - å•†å“ç®¡ç†ã¨åœ¨åº«åˆ¶å¾¡**

```sql
CREATE TABLE "foods" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "price" DOUBLE PRECISION NOT NULL,
    "category_id" INTEGER NOT NULL,
    "image_path" TEXT NOT NULL,
    "status" BOOLEAN NOT NULL DEFAULT true,
    -- åœ¨åº«ç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆé«˜åº¦ãªæ©Ÿèƒ½ï¼‰
    "stock" INTEGER NOT NULL DEFAULT 0,          -- å®Ÿåœ¨åº«
    "reserved" INTEGER NOT NULL DEFAULT 0,       -- äºˆç´„æ¸ˆã¿åœ¨åº«
    "min_stock" INTEGER NOT NULL DEFAULT 0,      -- æœ€å°åœ¨åº«é–¾å€¤
    "version" INTEGER NOT NULL DEFAULT 1,        -- æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "foods_pkey" PRIMARY KEY ("id")
);

ALTER TABLE "foods" ADD CONSTRAINT "foods_category_id_fkey"
    FOREIGN KEY ("category_id") REFERENCES "categories"("id")
    ON DELETE RESTRICT ON UPDATE CASCADE;
```

**é«˜åº¦ãªåœ¨åº«ç®¡ç†è¨­è¨ˆ:**
- **stock**: ç‰©ç†çš„ãªåœ¨åº«æ•°é‡
- **reserved**: ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‰ã‚Œã¦ã„ã‚‹ãŒæœªç¢ºå®šã®æ•°é‡
- **available = stock - reserved**: å®Ÿéš›ã«åˆ©ç”¨å¯èƒ½ãªæ•°é‡
- **min_stock**: è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ã®æœ€å°åœ¨åº«é–¾å€¤
- **version**: æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¸¦è¡Œåˆ¶å¾¡

---

### ðŸ›’ æ³¨æ–‡ãƒ»ã‚«ãƒ¼ãƒˆç³»ãƒ†ãƒ¼ãƒ–ãƒ«

#### **Carts ãƒ†ãƒ¼ãƒ–ãƒ« - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚«ãƒ¼ãƒˆ**

```sql
CREATE TABLE "carts" (
    "id" SERIAL NOT NULL,
    "user_id" INTEGER NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "carts_pkey" PRIMARY KEY ("id")
);

-- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1ã‚«ãƒ¼ãƒˆã®åˆ¶ç´„
CREATE UNIQUE INDEX "carts_user_id_key" ON "carts"("user_id");

ALTER TABLE "carts" ADD CONSTRAINT "carts_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "users"("id");
```

#### **CartItems ãƒ†ãƒ¼ãƒ–ãƒ« - ã‚«ãƒ¼ãƒˆå•†å“**

```sql
CREATE TABLE "cart_items" (
    "id" SERIAL NOT NULL,
    "cart_id" INTEGER NOT NULL,
    "food_id" INTEGER NOT NULL,
    "quantity" INTEGER NOT NULL DEFAULT 1,

    CONSTRAINT "cart_items_pkey" PRIMARY KEY ("id")
);

-- 1ã‚«ãƒ¼ãƒˆå†…ã§ã®å•†å“é‡è¤‡é˜²æ­¢
CREATE UNIQUE INDEX "cart_items_cart_id_food_id_key" ON "cart_items"("cart_id", "food_id");
```

**è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ:**
- **è¤‡åˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„**: åŒä¸€ã‚«ãƒ¼ãƒˆå†…ã§ã®å•†å“é‡è¤‡é˜²æ­¢
- **åœ¨åº«äºˆç´„é€£æº**: ã‚«ãƒ¼ãƒˆè¿½åŠ æ™‚ã«åœ¨åº«äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æº

#### **Orders ãƒ†ãƒ¼ãƒ–ãƒ« - æ³¨æ–‡ç®¡ç†**

```sql
CREATE TABLE "orders" (
    "id" SERIAL NOT NULL,
    "user_id" INTEGER NOT NULL,
    "total_amount" DOUBLE PRECISION NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "delivery_address" TEXT NOT NULL,
    "phone" TEXT NOT NULL,
    "notes" TEXT,
    "order_date" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "orders_pkey" PRIMARY KEY ("id")
);
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†:**
```
pending â†’ confirmed â†’ preparing â†’ delivery â†’ completed
                            â†“
                        cancelled
```

---

### ðŸ“ˆ å±¥æ­´ãƒ»ç›£æŸ»ç³»ãƒ†ãƒ¼ãƒ–ãƒ«

#### **OrderStatusHistory ãƒ†ãƒ¼ãƒ–ãƒ« - æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´**

```sql
CREATE TABLE "order_status_history" (
    "id" SERIAL NOT NULL,
    "order_id" INTEGER NOT NULL,
    "previous_status" TEXT NOT NULL,
    "new_status" TEXT NOT NULL,
    "updated_by" INTEGER NOT NULL,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "note" TEXT,

    CONSTRAINT "order_status_history_pkey" PRIMARY KEY ("id")
);

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX "order_status_history_order_id_idx" ON "order_status_history"("order_id");
CREATE INDEX "order_status_history_updated_at_idx" ON "order_status_history"("updated_at");
```

**ç›£æŸ»è¨¼è·¡æ©Ÿèƒ½:**
- **å®Œå…¨ãªå¤‰æ›´å±¥æ­´**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®å…¨è¨˜éŒ²
- **è²¬ä»»è¿½è·¡**: èª°ãŒã„ã¤å¤‰æ›´ã—ãŸã‹ã‚’è¨˜éŒ²
- **ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½**: å¤‰æ›´ç†ç”±ã®è¨˜éŒ²

#### **InventoryHistory ãƒ†ãƒ¼ãƒ–ãƒ« - åœ¨åº«å¤‰æ›´å±¥æ­´**

```sql
CREATE TABLE "inventory_history" (
    "id" SERIAL NOT NULL,
    "food_id" INTEGER NOT NULL,
    "change_type" TEXT NOT NULL,        -- 'add', 'subtract', 'reserve', 'release'
    "quantity" INTEGER NOT NULL,
    "previous_stock" INTEGER NOT NULL,
    "new_stock" INTEGER NOT NULL,
    "order_id" INTEGER,                 -- é–¢é€£æ³¨æ–‡IDï¼ˆä»»æ„ï¼‰
    "created_by" INTEGER NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "note" TEXT,

    CONSTRAINT "inventory_history_pkey" PRIMARY KEY ("id")
);

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX "inventory_history_food_id_idx" ON "inventory_history"("food_id");
CREATE INDEX "inventory_history_created_at_idx" ON "inventory_history"("created_at");
CREATE INDEX "inventory_history_change_type_idx" ON "inventory_history"("change_type");
```

**åœ¨åº«å¤‰æ›´ã®å®Œå…¨ç›£æŸ»:**
- **å¤‰æ›´ã‚¿ã‚¤ãƒ—**: add/subtract/reserve/release
- **å¤‰æ›´å‰å¾Œã®çŠ¶æ…‹**: åœ¨åº«æ•°ã®å®Œå…¨ãªè¿½è·¡
- **é–¢é€£æƒ…å ±**: æ³¨æ–‡ã¨ã®ç´ä»˜ã‘ã€å®Ÿè¡Œè€…ã®è¨˜éŒ²

---

### ðŸ”§ Prisma ã‚¹ã‚­ãƒ¼ãƒžè¨­è¨ˆ

#### **é–¢ä¿‚å®šç¾©ã®è©³ç´°**

```prisma
model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  password   String
  role       String   @default("customer")
  phone      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
  cart               Cart?                 // 1:1 é–¢ä¿‚
  orders             Order[]               // 1:N é–¢ä¿‚
  status_updates     OrderStatusHistory[]  // 1:N é–¢ä¿‚ï¼ˆæ›´æ–°è€…ã¨ã—ã¦ï¼‰
  inventory_changes  InventoryHistory[]    // 1:N é–¢ä¿‚ï¼ˆå¤‰æ›´è€…ã¨ã—ã¦ï¼‰

  @@map("users")
}
```

#### **é«˜åº¦ãªåˆ¶ç´„ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**

```prisma
model Food {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  price       Float
  category_id Int
  image_path  String
  status      Boolean  @default(true)

  // åœ¨åº«ç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  stock       Int      @default(0)
  reserved    Int      @default(0)
  min_stock   Int      @default(0)
  version     Int      @default(1)  // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  category         Category           @relation(fields: [category_id], references: [id])
  cart_items       CartItem[]
  order_items      OrderItem[]
  inventory_history InventoryHistory[]

  @@map("foods")
}
```

---

### âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥

#### **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥**

```sql
-- æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–
CREATE INDEX "foods_category_id_status_idx" ON "foods"("category_id", "status");
CREATE INDEX "foods_name_status_idx" ON "foods"("name", "status");

-- æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–
CREATE INDEX "orders_user_id_date_idx" ON "orders"("user_id", "order_date");
CREATE INDEX "inventory_history_food_created_idx" ON "inventory_history"("food_id", "created_at");

-- é›†è¨ˆã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
CREATE INDEX "order_items_order_id_idx" ON "order_items"("order_id");
```

#### **ã‚¯ã‚¨ãƒªæœ€é©åŒ–ä¾‹**

```typescript
// N+1å•é¡Œã‚’å›žé¿ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰æˆ¦ç•¥
const foods = await prisma.food.findMany({
  where: { status: true },
  include: {
    category: {
      select: { id: true, name: true, description: true }
    },
    inventory_history: {
      orderBy: { created_at: 'desc' },
      take: 1  // æœ€æ–°ã®å±¥æ­´ã®ã¿
    }
  },
  orderBy: { created_at: 'desc' }
});
```

---

### ðŸ” ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### **åˆ¶ç´„ã«ã‚ˆã‚‹æ•´åˆæ€§ä¿è¨¼**

```sql
-- å‚ç…§æ•´åˆæ€§åˆ¶ç´„
ALTER TABLE "foods" ADD CONSTRAINT "foods_category_id_fkey"
    FOREIGN KEY ("category_id") REFERENCES "categories"("id")
    ON DELETE RESTRICT;  -- ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤æ™‚ã¯å•†å“ã®å­˜åœ¨ã‚’ç¢ºèª

-- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ï¼ˆå°†æ¥çš„ãªæ‹¡å¼µï¼‰
ALTER TABLE "foods" ADD CONSTRAINT "foods_stock_positive"
    CHECK ("stock" >= 0);
ALTER TABLE "foods" ADD CONSTRAINT "foods_reserved_valid"
    CHECK ("reserved" >= 0 AND "reserved" <= "stock");
```

#### **æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¸¦è¡Œåˆ¶å¾¡**

```typescript
// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹ç«¶åˆåˆ¶å¾¡
const updateResult = await prisma.food.updateMany({
  where: {
    id: foodId,
    version: currentVersion  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
  },
  data: {
    stock: newStock,
    version: currentVersion + 1  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¢—åŠ 
  }
});

// æ›´æ–°ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯ç«¶åˆç™ºç”Ÿ
if (updateResult.count === 0) {
  throw new Error('CONCURRENT_UPDATE');
}
```

---

### ðŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é‹ç”¨è€ƒæ…®äº‹é …

#### **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚«ãƒãƒª**

```sql
-- å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥
-- 1. æ—¥æ¬¡ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
-- 2. æ™‚é–“å˜ä½ã®å¢—åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
-- 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®ç¶™ç¶šçš„ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

-- Point-in-Time Recovery è¨­å®š
-- archive_mode = on
-- wal_level = replica
```

#### **ç›£è¦–ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**

```sql
-- çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
ANALYZE;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†æ§‹ç¯‰
REINDEX DATABASE food_delivery;

-- ä¸è¦ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸå‰Šé™¤
DELETE FROM inventory_history
WHERE created_at < NOW() - INTERVAL '1 year';
```

#### **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è¨ˆç”»**

```sql
-- å°†æ¥çš„ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥
-- 1. å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœˆåˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
-- 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åœ°åŸŸåˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
-- 3. èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¬ãƒ—ãƒªã‚«ã®æ´»ç”¨

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ä¾‹ï¼ˆå°†æ¥çš„ï¼‰
CREATE TABLE inventory_history_2024_01 PARTITION OF inventory_history
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

---

### ðŸ“ˆ ãƒ‡ãƒ¼ã‚¿åˆ†æžã¨ãƒ¬ãƒãƒ¼ãƒˆ

#### **ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹ç”¨ãƒ“ãƒ¥ãƒ¼**

```sql
-- å•†å“å£²ä¸Šã‚µãƒžãƒªãƒ¼ãƒ“ãƒ¥ãƒ¼
CREATE VIEW food_sales_summary AS
SELECT
    f.id,
    f.name,
    f.category_id,
    c.name as category_name,
    COUNT(oi.id) as total_orders,
    SUM(oi.quantity) as total_quantity,
    SUM(oi.quantity * oi.price) as total_revenue,
    AVG(oi.price) as average_price
FROM foods f
LEFT JOIN order_items oi ON f.id = oi.food_id
LEFT JOIN orders o ON oi.order_id = o.id
LEFT JOIN categories c ON f.category_id = c.id
WHERE o.status = 'completed'
GROUP BY f.id, f.name, f.category_id, c.name;

-- åœ¨åº«çŠ¶æ³ç›£è¦–ãƒ“ãƒ¥ãƒ¼
CREATE VIEW inventory_status AS
SELECT
    f.id,
    f.name,
    f.stock,
    f.reserved,
    f.stock - f.reserved as available,
    f.min_stock,
    CASE
        WHEN f.stock <= f.min_stock THEN 'LOW_STOCK'
        WHEN f.stock - f.reserved <= 0 THEN 'OUT_OF_STOCK'
        ELSE 'NORMAL'
    END as stock_status
FROM foods f
WHERE f.status = true;
```

---

### ðŸ’¡ è¨­è¨ˆã®è©•ä¾¡ã¨å°†æ¥æ€§

#### **è¨­è¨ˆå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹**

| é …ç›® | è©•ä¾¡ | èª¬æ˜Ž |
|------|------|------|
| **æ­£è¦åŒ–** | â­â­â­â­â­ | 3NF ã‚’æº€ãŸã—ã€å†—é•·æ€§ã‚’æŽ’é™¤ |
| **æ•´åˆæ€§** | â­â­â­â­â­ | å¤–éƒ¨ã‚­ãƒ¼ã¨åˆ¶ç´„ã«ã‚ˆã‚‹å®Œå…¨æ€§ä¿è¨¼ |
| **æ‹¡å¼µæ€§** | â­â­â­â­â˜† | ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã¨ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹** | â­â­â­â­â­ | é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ |
| **ç›£æŸ»** | â­â­â­â­â­ | å®Œå…¨ãªå¤‰æ›´å±¥æ­´ã¨ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ |

#### **å°†æ¥çš„ãªæ‹¡å¼µè¨ˆç”»**

1. **ãƒžãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ**: ãƒ†ãƒŠãƒ³ãƒˆIDã«ã‚ˆã‚‹åˆ†é›¢
2. **åœ°ç†çš„åˆ†æ•£**: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ãƒ‡ãƒ¼ã‚¿åˆ†å‰²
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æž**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã¨ã®é€£æº
4. **æ©Ÿæ¢°å­¦ç¿’é€£æº**: æŽ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ç”¨ç‰¹å¾´é‡ãƒ†ãƒ¼ãƒ–ãƒ«
5. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: Event Sourcing ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å°Žå…¥

---

### ðŸŽ¯ ã¾ã¨ã‚

ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¯ã€å­¦ç¿’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚ŠãªãŒã‚‰ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®å“è³ªã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ï¼š

- **é«˜åº¦ãªåœ¨åº«ç®¡ç†**: æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¸¦è¡Œåˆ¶å¾¡
- **å®Œå…¨ãªç›£æŸ»è¨¼è·¡**: ã™ã¹ã¦ã®å¤‰æ›´å±¥æ­´ã‚’è¨˜éŒ²
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–**: æˆ¦ç•¥çš„ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: åˆ¶ç´„ã«ã‚ˆã‚‹åŽ³æ ¼ãªãƒ‡ãƒ¼ã‚¿å“è³ªç®¡ç†
- **å°†æ¥æ€§**: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã¨æ‹¡å¼µæ€§ã‚’è€ƒæ…®

ç‰¹ã«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆã¯ã€å®Ÿéš›ã®ECã‚µã‚¤ãƒˆã§å¿…è¦ã¨ãªã‚‹è¤‡é›‘ãªè¦ä»¶ã‚’æº€ãŸã—ã¦ãŠã‚Šã€éžå¸¸ã«å®Ÿè·µçš„ãªå­¦ç¿’ä¾¡å€¤ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚